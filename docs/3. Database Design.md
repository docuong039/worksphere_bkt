## DATABASE DESIGN DOCUMENT — Phần mềm Quản lý Công việc Enterprise (SaaS Multi-tenant)

**Vai trò thiết kế:** Database Architect / Data Modeler (Senior)  
**Phiên bản:** 1.0  
**Định hướng DBMS:** RDBMS (khuyến nghị PostgreSQL; tài liệu giữ mức “DB-agnostic” nơi có thể)

---

## 1. Mục tiêu & phạm vi Database Design

### 1.1. Tài liệu này dành cho ai?

- **BA/PO/PM**: đối chiếu nghiệp vụ (Epic/User Story) với dữ liệu cần lưu.
- **Backend engineers**: triển khai API/middleware phân quyền, truy vấn, migration.
- **Data/BI**: dashboard, reporting, audit, thống kê chi phí.
- **Security/Compliance**: kiểm soát multi-tenant isolation, audit trail, impersonation.
- **DBA/DevOps**: vận hành, backup/restore, tuning index/partition.

### 1.2. Mục đích

- Định nghĩa **schema chuẩn hoá (3NF)** cho nghiệp vụ quản lý công việc (task/subtask), time log, báo cáo định kỳ, dashboard, quản lý dự án, tài nguyên kỹ thuật.
- Tích hợp **RBAC/ABAC**, **audit logging**, **soft delete**, **data integrity**.
- Đảm bảo **multi-tenant SaaS**: cách thiết kế key, scope, index để mở rộng.

### 1.3. Phạm vi mô hình

- **Platform level**: Organization, quota, system admin, audit toàn cục, impersonation.
- **Tenant level (Org)**: user lifecycle, nội bộ phân quyền, cấu hình workspace.
- **Project level**: project, membership, task, assignee, tag, time log, lock period.
- **Reporting**: report tuần/tháng/quý, comment & reaction.
- **Data Integration**: Hỗ trợ **Import/Export** task qua Excel/CSV (bao gồm mapping custom fields).
- **Finance (scope-based)**: level/salary/cost-rate để tính chi phí theo time log.
- **Assets/Links**: tài liệu/form, link sheet, git, deploy.

Ngoài phạm vi (có thể bổ sung sau): billing/subscription thực thụ, SSO/SCIM, full-text search engine, event streaming.

---

## 2. Các yêu cầu kiến trúc

### 2.1. Multi-tenant (Org/Project)

- **Shared schema** (một schema dùng chung cho mọi Org), mỗi dòng dữ liệu tenant có **`org_id`**.
- Mọi quan hệ FK giữa các bảng tenant **đi qua composite key** `(org_id, id)` để ép dữ liệu không “cross-tenant”.
- Hỗ trợ **project scope** qua `project_id` + bảng membership.

### 2.2. Phân quyền (Hybrid RBAC & ABAC)

- **RBAC**: Role, Permission, Role_Permission, User_Role (có scope).
- **ABAC**: Ownership + thời gian (lock) + contextual scope (org/project).
  - Ví dụ: sửa/xóa `time_log` chỉ khi **`owner_user_id = current_user_id`** và **chưa lock kỳ**.
  - Tạo subtask chỉ khi user được gán task (membership/assignment).

### 2.3. Audit / log / soft delete / recycle bin

- Audit log ở mức **record-level** (ai làm gì, đối tượng nào, trước/sau).
- **Soft delete & Recycle Bin:**
  - Các bảng nghiệp vụ chính sử dụng `deleted_at` để lưu vết xóa mềm.
  - Mọi bản ghi có `deleted_at IS NOT NULL` được coi là nằm trong **Thùng rác**.
  - **Bảng `recycle_bin_items`:** Lưu trữ metadata (loại đối tượng, ID, tiêu đề, người xóa) của mọi hành động xóa mềm. Đây là nguồn dữ liệu chính để hiển thị giao diện Thùng rác tập trung.
  - Các câu truy vấn nghiệp vụ mặc định phải lọc `WHERE deleted_at IS NULL`.
  - Hệ thống hỗ trợ **Khôi phục (Restore)** bằng cách xóa giá trị `deleted_at` và xóa bản ghi tương ứng trong `recycle_bin_items`.
  - Hành động **Xóa vĩnh viễn** bằng lệnh DELETE vật lý và dọn dẹp `recycle_bin_items`.
- Impersonation bắt buộc có **session record** + audit liên kết.

### 2.4. Data integrity & constraint

- FK đầy đủ (ưu tiên `RESTRICT` / `NO ACTION` cho dữ liệu lịch sử; `CASCADE` có kiểm soát cho bảng mapping).
- Unique constraint để chống dữ liệu trùng (membership, role name trong org, tag name trong project…).
- Check constraint / lookup table cho enum nghiệp vụ (status/priority/type…).
- Optimistic concurrency: `row_version` hoặc `updated_at` + “compare-and-swap”.

---

## 3. Danh sách entity / bảng dữ liệu chính

> Quy ước type mang tính “portable”; nơi cần có thể map sang DBMS cụ thể:
>
> - `uuid` (khuyến nghị) hoặc `bigint` (snowflake/identity).
> - `timestamptz` (khuyến nghị) hoặc `datetime` + timezone strategy.
> - `jsonb` (khuyến nghị) hoặc `json`/`text`.

### 3.1. Nhóm Platform & Tenant core

#### 3.1.1. `organizations`

**Mô tả:** Tổ chức (tenant) của khách hàng.

| Column     | Type         |     Null | Default            | Constraints  | Comment                                |
| ---------- | ------------ | -------: | ------------------ | ------------ | -------------------------------------- |
| id         | uuid         | NOT NULL | gen                | PK           | ID duy nhất của tổ chức (UUID)         |
| code       | varchar(50)  | NOT NULL |                    | UQ           | Mã định danh ngắn (slug) của tổ chức   |
| name       | varchar(255) | NOT NULL |                    |              | Tên hiển thị của tổ chức               |
| status     | varchar(30)  | NOT NULL | `ACTIVE`           | CK           | Trạng thái: PENDING, ACTIVE, SUSPENDED |
| timezone   | varchar(64)  | NOT NULL | `Asia/Ho_Chi_Minh` |              | Múi giờ làm việc của tổ chức           |
| created_at | timestamptz  | NOT NULL | now                |              | Thời điểm tạo bản ghi                  |
| created_by | uuid         |     NULL |                    | FK(users.id) | ID người tạo (System Admin hoặc User)  |
| updated_at | timestamptz  | NOT NULL | now                |              | Thời điểm cập nhật cuối cùng           |
| updated_by | uuid         |     NULL |                    | FK(users.id) | ID người cập nhật cuối cùng            |
| deleted_at | timestamptz  |     NULL |                    |              | Thời điểm xóa (Soft delete)            |
| deleted_by | uuid         |     NULL |                    | FK(users.id) | ID người thực hiện xóa                 |

**Constraints:**

- PK: `(id)`
- Unique: `(code)` (toàn cục)
- Check: `status IN ('PENDING','ACTIVE','SUSPENDED')`

---

#### 3.1.2. `org_quotas`

**Mô tả:** Giới hạn gói dịch vụ theo Org (US-SYS-01-07).

| Column         | Type        |     Null | Default      | Constraints              | Comment                                    |
| -------------- | ----------- | -------: | ------------ | ------------------------ | ------------------------------------------ |
| org_id         | uuid        | NOT NULL |              | PK, FK(organizations.id) | ID tổ chức áp dụng quota                   |
| max_users      | int         | NOT NULL | 50           | CK                       | Số lượng người dùng tối đa cho phép (>= 0) |
| max_storage_mb | int         | NOT NULL | 1024         | CK                       | Dung lượng lưu trữ tối đa (MB) (>= 0)      |
| max_projects   | int         | NOT NULL | 50           | CK                       | Số lượng dự án tối đa cho phép (>= 0)      |
| effective_from | date        | NOT NULL | current_date |                          | Ngày bắt đầu áp dụng gói quota             |
| effective_to   | date        |     NULL |              |                          | Ngày hết hạn gói quota (NULL là vô hạn)    |
| created_at     | timestamptz | NOT NULL | now          |                          | Ngày tạo thiết lập quota                   |
| created_by     | uuid        |     NULL |              | FK(users.id)             | ID người thiết lập (System Admin)          |

**Constraints:**

- PK: `(org_id)`
- Check: `max_users >= 0 AND max_storage_mb >= 0 AND max_projects >= 0`

---

#### 3.1.3. `users`

**Mô tả:** Danh tính người dùng toàn cục (identity). Một user có thể thuộc 1+ Org qua `org_memberships`.

| Column                 | Type         |     Null | Default  | Constraints | Comment                                        |
| ---------------------- | ------------ | -------: | -------- | ----------- | ---------------------------------------------- |
| id                     | uuid         | NOT NULL | gen      | PK          | ID duy nhất của người dùng (Identity toàn cục) |
| email                  | varchar(320) | NOT NULL |          | UQ          | Email đăng nhập (duy nhất toàn hệ thống)       |
| password_hash          | varchar(255) | NOT NULL |          |             | Mật khẩu đã mã hóa (BCrypt/Argon2)             |
| full_name              | varchar(255) | NOT NULL |          |             | Họ và tên đầy đủ                               |
| phone                  | varchar(30)  |     NULL |          |             | Số điện thoại liên lạc                         |
| status                 | varchar(30)  | NOT NULL | `ACTIVE` | CK          | Trạng thái tài khoản: ACTIVE, LOCKED           |
| reset_token            | varchar(255) |     NULL |          |             | Mã token để reset mật khẩu                     |
| reset_token_expires_at | timestamptz  |     NULL |          |             | Thời gian hết hạn của reset token              |
| last_login_at          | timestamptz  |     NULL |          |             | Thời điểm đăng nhập thành công gần nhất        |
| created_at             | timestamptz  | NOT NULL | now      |             | Thời điểm đăng ký tài khoản                    |
| updated_at             | timestamptz  | NOT NULL | now      |             | Thời điểm cập nhật thông tin gần nhất          |
| deleted_at             | timestamptz  |     NULL |          |             | Thời điểm xóa tài khoản (nếu có)               |

**Constraints:**

- Unique: `(email)`
- Check: `status IN ('ACTIVE','LOCKED')`

---

#### 3.1.4. `org_memberships`

**Mô tả:** User tham gia một Org (lifecycle: invite/manual/deactivate/reactivate).

| Column         | Type        |     Null | Default  | Constraints              | Comment                                                       |
| -------------- | ----------- | -------: | -------- | ------------------------ | ------------------------------------------------------------- |
| org_id         | uuid        | NOT NULL |          | PK, FK(organizations.id) | ID tổ chức                                                    |
| user_id        | uuid        | NOT NULL |          | PK, FK(users.id)         | ID người dùng tham gia tổ chức                                |
| member_status  | varchar(30) | NOT NULL | `ACTIVE` | CK                       | Trạng thái thành viên trong Org: INVITED, ACTIVE, DEACTIVATED |
| join_method    | varchar(30) | NOT NULL | `MANUAL` | CK                       | Phương thức gia nhập: MANUAL, INVITE                          |
| invited_by     | uuid        |     NULL |          | FK(users.id)             | ID người gửi lời mời                                          |
| invited_at     | timestamptz |     NULL |          |                          | Thời điểm gửi lời mời                                         |
| activated_at   | timestamptz |     NULL |          |                          | Thời điểm tài khoản được kích hoạt trong Org                  |
| deactivated_at | timestamptz |     NULL |          |                          | Thời điểm bị vô hiệu hóa truy cập vào Org                     |
| deactivated_by | uuid        |     NULL |          | FK(users.id)             | ID người thực hiện vô hiệu hóa                                |
| created_at     | timestamptz | NOT NULL | now      |                          | Thời điểm tạo bản ghi                                         |
| updated_at     | timestamptz | NOT NULL | now      |                          | Thời điểm cập nhật bản ghi                                    |

**Constraints:**

- PK: `(org_id, user_id)`
- Check: `member_status IN ('INVITED','ACTIVE','DEACTIVATED')`
- Check: `join_method IN ('MANUAL','INVITE')`

---

#### 3.1.5. `org_invites`

**Mô tả:** Link mời gia nhập Org (US-ORG-01-02) với TTL và khả năng refresh/vô hiệu hoá.

| Column      | Type         |     Null | Default | Constraints          | Comment                               |
| ----------- | ------------ | -------: | ------- | -------------------- | ------------------------------------- |
| id          | uuid         | NOT NULL | gen     | PK                   | ID bản ghi lời mời                    |
| org_id      | uuid         | NOT NULL |         | FK(organizations.id) | ID tổ chức gửi lời mời                |
| invite_code | varchar(128) | NOT NULL |         | UQ                   | Mã token/code để gia nhập (Join code) |
| email_hint  | varchar(320) |     NULL |         |                      | Gợi ý email người được mời (nếu có)   |
| expires_at  | timestamptz  | NOT NULL |         |                      | Thời điểm mã mời hết hạn (TTL)        |
| revoked_at  | timestamptz  |     NULL |         |                      | Thời điểm mã mời bị thu hồi sớm       |
| revoked_by  | uuid         |     NULL |         | FK(users.id)         | ID người thu hồi mã mời               |
| created_at  | timestamptz  | NOT NULL | now     |                      | Thời điểm tạo bản ghi                 |
| created_by  | uuid         | NOT NULL |         | FK(users.id)         | ID Org Admin tạo mã mời               |

**Constraints:**

- Unique: `(invite_code)`
- Index: `(org_id, expires_at)` để cleanup

---

#### 3.1.6. `user_profiles`

**Mô tả:** Thông tin lý lịch chi tiết của nhân sự (US-CEO-02-03).

| Column              | Type         |     Null | Default | Constraints      | Comment                                  |
| ------------------- | ------------ | -------: | ------- | ---------------- | ---------------------------------------- |
| user_id             | uuid         | NOT NULL |         | PK, FK(users.id) | ID người dùng (FK từ users)              |
| birth_date          | date         |     NULL |         |                  | Ngày sinh                                |
| gender              | varchar(10)  |     NULL |         |                  | Giới tính                                |
| address             | text         |     NULL |         |                  | Địa chỉ thường trú/tạm trú               |
| id_number           | varchar(50)  |     NULL |         |                  | Số CCCD/Passport                         |
| id_issued_date      | date         |     NULL |         |                  | Ngày cấp CCCD                            |
| id_issued_place     | varchar(255) |     NULL |         |                  | Nơi cấp CCCD                             |
| academic_level      | varchar(100) |     NULL |         |                  | Trình độ học vấn (Đại học, Thạc sĩ...)   |
| tax_code            | varchar(50)  |     NULL |         |                  | Mã số thuế cá nhân                       |
| bank_account_number | varchar(50)  |     NULL |         |                  | Số tài khoản ngân hàng                   |
| bank_name           | varchar(255) |     NULL |         |                  | Tên ngân hàng                            |
| bio                 | text         |     NULL |         |                  | Giới thiệu bản thân/Tóm tắt lý lịch      |
| avatar_url          | text         |     NULL |         |                  | Đường dẫn ảnh đại diện                   |
| metadata            | jsonb        |     NULL |         |                  | Các thông tin tùy chỉnh khác (Dạng JSON) |
| updated_at          | timestamptz  | NOT NULL | now     |                  | Thời điểm cập nhật thông tin gần nhất    |

---

### 3.2. Nhóm Project / Task / Subtask / Tag

#### 3.2.1. `projects`

**Mô tả:** Dự án thuộc Org (US-MNG-01-01).

| Column      | Type         |     Null | Default  | Constraints          | Comment                                  |
| ----------- | ------------ | -------: | -------- | -------------------- | ---------------------------------------- |
| id          | uuid         | NOT NULL | gen      | PK                   | ID dự án                                 |
| org_id      | uuid         | NOT NULL |          | FK(organizations.id) | ID tổ chức sở hữu dự án                  |
| code        | varchar(50)  | NOT NULL |          |                      | Mã dự án nội bộ trong Org (ví dụ: PJ001) |
| name        | varchar(255) | NOT NULL |          |                      | Tên dự án                                |
| description | text         |     NULL |          |                      | Mô tả mục tiêu/phạm vi dự án             |
| status      | varchar(30)  | NOT NULL | `ACTIVE` | CK                   | Trạng thái: ACTIVE, ARCHIVED             |
| start_date  | date         |     NULL |          |                      | Ngày bắt đầu dự kiến/thực tế             |
| end_date    | date         |     NULL |          |                      | Ngày kết thúc dự kiến                    |
| created_at  | timestamptz  | NOT NULL | now      |                      | Thời điểm tạo bản ghi                    |
| created_by  | uuid         | NOT NULL |          | FK(users.id)         | ID PM hoặc Org Admin tạo dự án           |
| updated_at  | timestamptz  | NOT NULL | now      |                      | Thời điểm cập nhật cuối cùng             |
| updated_by  | uuid         |     NULL |          | FK(users.id)         | ID người cập nhật cuối cùng              |
| deleted_at  | timestamptz  |     NULL |          |                      | Thời điểm xóa (Soft delete)              |

**Constraints:**

- PK: `(id)`
- Unique: `(org_id, code)`
- Unique (composite tenant): `(org_id, id)` (để FK composite)
- Check: `status IN ('ACTIVE','ARCHIVED')`

---

#### 3.2.2. `project_members`

**Mô tả:** Thành viên dự án (scope theo project; phục vụ PM scope).

| Column      | Type        |     Null | Default  | Constraints           | Comment                                        |
| ----------- | ----------- | -------: | -------- | --------------------- | ---------------------------------------------- |
| org_id      | uuid        | NOT NULL |          | PK part               | ID tổ chức                                     |
| project_id  | uuid        | NOT NULL |          | PK part, FK(projects) | ID dự án                                       |
| user_id     | uuid        | NOT NULL |          | PK part, FK(users.id) | ID người dùng tham gia dự án                   |
| member_role | varchar(30) | NOT NULL | `MEMBER` | CK                    | Vai trò cụ thể trong dự án: PM, MEMBER, VIEWER |
| joined_at   | timestamptz | NOT NULL | now      |                       | Ngày gia nhập dự án                            |
| left_at     | timestamptz |     NULL |          |                       | Ngày rời khỏi dự án (nếu có)                   |

**Constraints:**

- PK: `(org_id, project_id, user_id)`
- FK: `(org_id, project_id) -> projects(org_id, id)`
- Check: `member_role IN ('PM','MEMBER','VIEWER')`

---

#### 3.2.3. Lookup tables: `task_statuses`, `task_priorities`, `task_types`

**Mô tả:** Chuẩn hoá danh mục nghiệp vụ; giúp đổi tên/thiết lập thêm về sau (ORG-03-03).

`task_statuses`:

- `code` (PK): Mã trạng thái (TODO, IN_PROGRESS, DONE, BLOCKED)
- `name`: Tên hiển thị (To Do, Đang làm...)
- `sort_order`: Thứ tự hiển thị trên Kanban/List
- `is_terminal`: Đánh dấu đây là trạng thái kết thúc

`task_priorities`:

- `code` (PK): Mã độ ưu tiên (LOW, MEDIUM, HIGH, URGENT)
- `name`: Tên mức độ ưu tiên
- `sort_order`: Thứ tự sắp xếp

`task_types`:

- `code` (PK): Loại công việc (TASK, BUG, FEATURE)
- `name`: Tên loại công việc

---

#### 3.2.4. `tasks`

**Mô tả:** Task thuộc project; có thể gán nhiều người (US-MNG-01-02), filter/search (US-EMP-01-02), trạng thái (US-EMP-01-05), priority/tag (US-MNG-01-03), theo dõi test/fix (US-MNG-01-04).

| Column        | Type         |     Null | Default  | Constraints              | Comment                                            |
| ------------- | ------------ | -------: | -------- | ------------------------ | -------------------------------------------------- |
| id            | uuid         | NOT NULL | gen      | PK                       | ID công việc                                       |
| org_id        | uuid         | NOT NULL |          |                          | ID tổ chức                                         |
| project_id    | uuid         | NOT NULL |          | FK(projects)             | Thuộc dự án nào                                    |
| title         | varchar(500) | NOT NULL |          |                          | Tiêu đề công việc                                  |
| description   | text         |     NULL |          |                          | Mô tả chi tiết yêu cầu (Hỗ trợ Rich Text/HTML)     |
| status_code   | varchar(30)  | NOT NULL | `TODO`   | FK(task_statuses.code)   | Trạng thái hiện tại                                |
| priority_code | varchar(30)  | NOT NULL | `MEDIUM` | FK(task_priorities.code) | Độ ưu tiên                                         |
| type_code     | varchar(30)  | NOT NULL | `TASK`   | FK(task_types.code)      | Loại task                                          |
| start_date    | date         |     NULL |          |                          | Ngày bắt đầu (để vẽ Gantt)                         |
| due_date      | date         |     NULL |          |                          | Hạn chót hoàn thành (Ngày kết thúc Gantt)          |
| started_at    | timestamptz  |     NULL |          |                          | Thời điểm thực tế bắt đầu làm                      |
| completed_at  | timestamptz  |     NULL |          |                          | Thời điểm thực tế hoàn thành                       |
| sort_order    | int          | NOT NULL | 0        |                          | Thứ tự sắp xếp hiển thị của Task                   |
| created_at    | timestamptz  | NOT NULL | now      |                          | Thời điểm tạo task                                 |
| created_by    | uuid         | NOT NULL |          | FK(users.id)             | Người tạo task                                     |
| updated_at    | timestamptz  | NOT NULL | now      |                          | Thời điểm cập nhật task                            |
| updated_by    | uuid         |     NULL |          | FK(users.id)             | ID người cập nhật cuối cùng                        |
| row_version   | bigint       | NOT NULL | 1        |                          | Số phiên bản bản ghi (Dùng cho Optimistic Locking) |
| deleted_at    | timestamptz  |     NULL |          |                          | Thời điểm xóa (Soft delete)                        |
| deleted_by    | uuid         |     NULL |          | FK(users.id)             | ID người thực hiện xóa                             |

**Constraints:**

- PK: `(id)`
- Unique: `(org_id, id)` (composite tenant key)
- FK: `(org_id, project_id) -> projects(org_id, id)`
- Index-heavy: theo assignee/status/priority/due_date (xem mục 8)

---

#### 3.2.5. `task_assignees`

**Mô tả:** N-N giữa task và user (gán nhiều người 1 task).

| Column      | Type        |     Null | Default | Constraints           | Comment                  |
| ----------- | ----------- | -------: | ------- | --------------------- | ------------------------ |
| org_id      | uuid        | NOT NULL |         | PK part               | ID tổ chức               |
| task_id     | uuid        | NOT NULL |         | PK part, FK(tasks)    | ID công việc             |
| user_id     | uuid        | NOT NULL |         | PK part, FK(users.id) | Người được giao việc     |
| assigned_by | uuid        | NOT NULL |         | FK(users.id)          | Người thực hiện gán việc |
| assigned_at | timestamptz | NOT NULL | now     |                       | Thời điểm gán            |

**Constraints:**

- PK: `(org_id, task_id, user_id)`
- FK: `(org_id, task_id) -> tasks(org_id, id)`
- Index: `(org_id, user_id, assigned_at)`

---

#### 3.2.6. `subtasks`

**Mô tả:** Đầu việc con; chỉ người tạo được sửa/xoá (ABAC ownership) (US-EMP-01-03, 01-04).

| Column      | Type         |     Null | Default | Constraints            | Comment                                        |
| ----------- | ------------ | -------: | ------- | ---------------------- | ---------------------------------------------- |
| id          | uuid         | NOT NULL | gen     | PK                     | ID bản ghi                                     |
| org_id      | uuid         | NOT NULL |         |                        | ID tổ chức                                     |
| task_id     | uuid         | NOT NULL |         | FK(tasks)              | ID của task cha                                |
| title       | varchar(500) | NOT NULL |         |                        | Nội dung đầu việc con                          |
| status_code | varchar(30)  | NOT NULL | `TODO`  | FK(task_statuses.code) | Trạng thái của subtask                         |
| start_date  | date         |     NULL |         |                        | Ngày bắt đầu subtask                           |
| end_date    | date         |     NULL |         |                        | Ngày kết thúc subtask                          |
| sort_order  | int          | NOT NULL | 0       |                        | Thứ tự sắp xếp hiển thị của Subtask            |
| created_at  | timestamptz  | NOT NULL | now     |                        | Thời điểm tạo bản ghi                          |
| created_by  | uuid         | NOT NULL |         | FK(users.id)           | Người tạo subtask (Chỉ người này được sửa/xóa) |
| updated_at  | timestamptz  | NOT NULL | now     |                        | Thời điểm cập nhật bản ghi                     |
| updated_by  | uuid         |     NULL |         | FK(users.id)           | ID người cập nhật cuối cùng                    |
| deleted_at  | timestamptz  |     NULL |         |                        | Thời điểm xóa (Soft delete)                    |

**Constraints:**

- Unique: `(org_id, id)`
- FK: `(org_id, task_id) -> tasks(org_id, id)`
- Check logic (App layer): `end_date >= start_date`

---

#### 3.2.7. `tags` và `task_tags`

**Mô tả:** Tag dùng chung trong Org (không giới hạn theo project) để phân loại công việc (US-MNG-01-03).

`tags`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| id | uuid | NOT NULL | gen | PK | ID nhãn |
| org_id | uuid | NOT NULL | | FK(organizations.id) | ID tổ chức |
| name | varchar(100) | NOT NULL | | | Tên nhãn |
| color_code | varchar(7) | NULL | | | Mã màu HEX (ví dụ: #FF0000) |
| created_at | timestamptz | NOT NULL | now | | |
| created_by | uuid | NULL | | FK(users.id) | |

**Constraints:**

- PK: `(id)`
- Unique (composite tenant): `(org_id, id)`
- Unique: `(org_id, name)`

`task_tags`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| org_id | uuid | NOT NULL | | PK part | |
| task_id | uuid | NOT NULL | | PK part, FK(tasks) | |
| tag_id | uuid | NOT NULL | | PK part, FK(tags) | |

**Constraints:**

- PK: `(org_id, task_id, tag_id)`
- FK: `(org_id, task_id) -> tasks(org_id, id)`
- FK: `(org_id, tag_id) -> tags(org_id, id)`

---

#### 3.2.8. `task_comments` và `subtask_comments`

**Mô tả:** Hệ thống thảo luận và trao đổi trực tiếp trên công việc (US-EMP-01-07, US-MNG-01-06). Hỗ trợ cuộc trò chuyện theo thread.

`task_comments`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| id | uuid | NOT NULL | gen | PK | |
| org_id | uuid | NOT NULL | | FK(organizations.id) | |
| task_id | uuid | NOT NULL | | FK(tasks) | |
| author_user_id | uuid | NOT NULL | | FK(users.id) | Người bình luận |
| parent_comment_id | uuid | NULL | | FK(task_comments) | ID comment cha (null nếu reply) |
| content | text | NOT NULL | | | Nội dung thảo luận (Rich Text) |
| created_at | timestamptz | NOT NULL | now | | |
| updated_at | timestamptz | NOT NULL | now | | |
| updated_by | uuid | NULL | | FK(users.id) | ID người chỉnh sửa |
| deleted_at | timestamptz | NULL | | | Soft delete timestamp |
| deleted_by | uuid | NULL | | FK(users.id) | ID người thực hiện xóa |

`subtask_comments`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| id | uuid | NOT NULL | gen | PK | |
| org_id | uuid | NOT NULL | | FK(organizations.id) | |
| subtask_id | uuid | NOT NULL | | FK(subtasks.id) | |
| author_user_id | uuid | NOT NULL | | FK(users.id) | |
| parent_comment_id | uuid | NULL | | FK(subtask_comments) | ID comment cha (null nếu reply) |
| content | text | NOT NULL | | | |
| created_at | timestamptz | NOT NULL | now | | |
| updated_at | timestamptz | NOT NULL | now | | |
| updated_by | uuid | NULL | | FK(users.id) | |
| deleted_at | timestamptz | NULL | | | |
| deleted_by | uuid | NULL | | FK(users.id) | |

#### 3.2.9. `task_comment_mentions` và `subtask_comment_mentions`

**Mô tả:** Bảng lưu trữ danh sách người được tag/mention trong comment (US-EMP-01-08, US-MNG-01-08).

`task_comment_mentions`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| id | uuid | NOT NULL | gen | PK | |
| org_id | uuid | NOT NULL | | FK(organizations.id) | |
| task_id | uuid | NOT NULL | | FK(tasks.org_id, id) | |
| comment_id | uuid | NOT NULL | | FK(task_comments.id) | |
| mentioned_user_id | uuid | NOT NULL | | FK(users.id) | Người được mention |
| created_at | timestamptz | NOT NULL | now | | |

`subtask_comment_mentions`: Tương tự nhưng FK tới `subtasks` và `subtask_comments`.

---

### 3.3. Nhóm Time log & Lock chu kỳ

#### 3.3.1. `work_period_locks`

**Mô tả:** Khóa/mở khóa theo tuần/tháng (MNG-04). Có thể thiết kế ở mức **project** (khuyến nghị) để PM kiểm soát theo dự án.

| Column       | Type        |     Null | Default | Constraints  | Comment                              |
| ------------ | ----------- | -------: | ------- | ------------ | ------------------------------------ |
| id           | uuid        | NOT NULL | gen     | PK           | ID bản ghi                           |
| org_id       | uuid        | NOT NULL |         |              | ID tổ chức                           |
| project_id   | uuid        | NOT NULL |         | FK(projects) | Khóa theo dự án                      |
| period_type  | varchar(20) | NOT NULL |         | CK           | Loại chu kỳ: WEEK, MONTH, QUARTER    |
| period_start | date        | NOT NULL |         |              | Ngày bắt đầu chu kỳ                  |
| period_end   | date        | NOT NULL |         |              | Ngày kết thúc chu kỳ                 |
| is_locked    | boolean     | NOT NULL | false   |              | Trạng thái khóa (ngăn chặn log/edit) |
| locked_at    | timestamptz |     NULL |         |              | Thời điểm thực hiện khóa             |
| locked_by    | uuid        |     NULL |         | FK(users.id) | PM thực hiện khóa                    |
| unlocked_at  | timestamptz |     NULL |         |              | Thời điểm thực hiện mở khóa          |
| unlocked_by  | uuid        |     NULL |         | FK(users.id) | PM thực hiện mở khóa                 |
| lock_reason  | text        |     NULL |         |              | Lý do khóa hoặc mở khóa              |
| created_at   | timestamptz | NOT NULL | now     |              | Thời điểm tạo bản ghi                |

**Constraints:**

- Unique: `(org_id, project_id, period_type, period_start, period_end)`
- Check: `period_end >= period_start`
- Check: `period_type IN ('WEEK','MONTH','QUARTER')`

---

#### 3.3.2. `time_logs`

**Mô tả:** Ghi nhận thời gian làm việc (EMP-02).

- **Quy tắc nghiệp vụ:**
  - **Trạng thái hoàn thành:**
    - Chỉ cho phép tạo bản ghi log time khi Task chính ở trạng thái `DONE` (nếu log cho task) hoặc Subtask ở trạng thái `is_done = true` (nếu log cho subtask).
    - Chỉ PM/MNG mới có quyền chuyển Task sang `DONE`. EMP có quyền chuyển Subtask sang `is_done`.
  - Nếu Task có Subtask: Bắt buộc log vào Subtask (`subtask_id` NOT NULL).
  - Nếu Task không có Subtask: Log trực tiếp vào Task (`subtask_id` IS NULL).
- **Chi phí dự án:** Luôn tính dựa trên tổng `minutes` của Task (không phân biệt log trực tiếp hay qua subtask). Subtask log chỉ phục vụ mục đích phân tích chi tiết.
- **ABAC:** chỉ owner sửa/xóa; temporal: cấm sửa khi lock.

| Column        | Type        |     Null | Default | Constraints  | Comment                                 |
| ------------- | ----------- | -------: | ------- | ------------ | --------------------------------------- |
| id            | uuid        | NOT NULL | gen     | PK           | ID bản ghi                              |
| org_id        | uuid        | NOT NULL |         |              | ID tổ chức                              |
| project_id    | uuid        | NOT NULL |         | FK(projects) | ID dự án                                |
| task_id       | uuid        | NOT NULL |         | FK(tasks)    | ID công việc chính                      |
| subtask_id    | uuid        |     NULL |         | FK(subtasks) | ID đầu việc con (nếu log cho subtask)   |
| owner_user_id | uuid        | NOT NULL |         | FK(users.id) | Người thực hiện công việc (Người log)   |
| work_date     | date        | NOT NULL |         |              | Ngày làm việc thực tế                   |
| minutes       | int         | NOT NULL | 0       | CK           | Số phút làm việc (> 0)                  |
| note          | text        |     NULL |         |              | Ghi chú công việc đã làm                |
| created_at    | timestamptz | NOT NULL | now     |              | Thời điểm tạo bản ghi                   |
| created_by    | uuid        | NOT NULL |         | FK(users.id) | ID người tạo (thường là owner)          |
| updated_at    | timestamptz | NOT NULL | now     |              | Thời điểm cập nhật cuối cùng            |
| updated_by    | uuid        |     NULL |         | FK(users.id) | ID người cập nhật cuối cùng             |
| deleted_at    | timestamptz |     NULL |         |              | Thời điểm xóa (Soft delete)             |
| row_version   | bigint      | NOT NULL | 1       |              | Version để kiểm soát cập nhật đồng thời |

**Constraints:**

- Unique (khuyến nghị): `(org_id, owner_user_id, task_id, subtask_id, work_date, created_at)`
- FK: `(org_id, project_id) -> projects(org_id, id)`
- FK: `(org_id, task_id) -> tasks(org_id, id)`
- FK: `(subtask_id) -> subtasks(id)`
- Check: `minutes > 0`

**ABAC enforcement note (DB-level options):**

- App-layer: validate `owner_user_id == current_user_id` + not locked.
- DB-layer (PostgreSQL): RLS + policy kiểm tra `org_id` và ownership; lock check qua join `work_period_locks`.

---

#### 3.3.3. `activity_events`

**Mô tả:** Activity Feed (kiểu Redmine) — bản ghi **mang tính nghiệp vụ** để hiển thị “ai làm gì vào lúc nào” theo **ngày**.  
Khác với `audit_logs` (compliance/system-level), `activity_events` phục vụ UI và phân tích vận hành:

- **EMP**: xem activity của chính mình theo từng ngày.
- **PM/MNG**: xem activity của chính mình + toàn bộ EMP trong các project mình quản lý (project scope).
- **CEO/Chủ tịch**: xem activity toàn bộ nhân sự trong org (org scope).
- **SysAdmin/Org Admin**: không cần dùng activity; dùng `audit_logs` khi cần truy vết hệ thống.

| Column        | Type         |     Null | Default | Constraints  | Comment                                                        |
| ------------- | ------------ | -------: | ------- | ------------ | -------------------------------------------------------------- |
| id            | uuid         | NOT NULL | gen     | PK           | ID bản ghi                                                     |
| org_id        | uuid         | NOT NULL |         |              | ID tổ chức                                                     |
| project_id    | uuid         |     NULL |         | FK(projects) | Project liên quan (NULL nếu là activity org-wide)              |
| actor_user_id | uuid         | NOT NULL |         | FK(users.id) | Người tạo ra activity (người thực hiện hành động)              |
| activity_date | date         | NOT NULL |         |              | Ngày hoạt động (theo timezone Org), phục vụ filter theo ngày   |
| occurred_at   | timestamptz  | NOT NULL | now     |              | Thời điểm xảy ra sự kiện                                       |
| activity_type | varchar(50)  | NOT NULL |         |              | Loại sự kiện (TASK_DONE, SUBTASK_DONE, LOG_TIME, COMMENT, ...) |
| entity_type   | varchar(50)  |     NULL |         |              | Loại đối tượng (TASK, SUBTASK, TIME_LOG, REPORT, ...)          |
| entity_id     | uuid         |     NULL |         |              | ID đối tượng (polymorphic, không FK cứng)                      |
| summary       | varchar(500) | NOT NULL |         |              | Mô tả ngắn để render UI                                        |
| metadata      | jsonb        |     NULL |         |              | Dữ liệu bổ sung (task_id, subtask_id, minutes, ...)            |

**Index khuyến nghị:**

- `(org_id, activity_date, actor_user_id)`
- `(org_id, project_id, activity_date)`
- `(org_id, occurred_at desc)`

---

#### 3.3.4. `notifications` và `notification_recipients`

**Mô tả:** Hệ thống thông báo tới người dùng — trả lời được 3 câu hỏi:

- **Thông báo cái gì (What):** sự kiện nghiệp vụ (TASK_ASSIGNED, TASK_DONE, SUBTASK_DONE, COMMENT, LOCK/UNLOCK, REPORT_SUBMITTED, …)
- **Tới ai (Who):** 1+ người nhận theo scope:
  - EMP: theo “được gán task”, “comment liên quan”, “task done/lock-unlock ảnh hưởng logtime”
  - PM/MNG: theo project mình quản lý (event của EMP trong project)
  - CEO: org-wide (event quan trọng/“đỏ”)
- **Khi nào (When):** ngay khi event xảy ra; lưu trạng thái đọc/chưa đọc theo user.

Thiết kế theo 2 tầng:

- `notifications`: bản ghi thông báo (nội dung + loại + liên kết đối tượng)
- `notification_recipients`: ai nhận + trạng thái đã đọc/chưa đọc (per-user)

`notifications`:

| Column            | Type         |     Null | Default | Constraints  | Comment                                              |
| ----------------- | ------------ | -------: | ------- | ------------ | ---------------------------------------------------- |
| id                | uuid         | NOT NULL | gen     | PK           | ID thông báo                                         |
| org_id            | uuid         | NOT NULL |         |              | ID tổ chức                                           |
| project_id        | uuid         |     NULL |         | FK(projects) | Project liên quan (NULL nếu org-wide)                |
| created_at        | timestamptz  | NOT NULL | now     |              | Thời điểm tạo thông báo                              |
| notification_type | varchar(50)  | NOT NULL |         |              | TASK_ASSIGNED, TASK_DONE, SUBTASK_DONE, COMMENT, ... |
| title             | varchar(255) | NOT NULL |         |              | Tiêu đề thông báo                                    |
| body              | text         | NOT NULL |         |              | Nội dung thông báo                                   |
| entity_type       | varchar(50)  |     NULL |         |              | TASK, SUBTASK, REPORT, ...                           |
| entity_id         | uuid         |     NULL |         |              | ID đối tượng (polymorphic, không FK cứng)            |
| actor_user_id     | uuid         |     NULL |         | FK(users.id) | Người tạo event (người thực hiện hành động), nếu có  |
| metadata          | jsonb        |     NULL |         |              | Payload bổ sung (minutes, due_date, …)               |

`notification_recipients`:

| Column          | Type        |     Null | Default | Constraints | Comment                    |
| --------------- | ----------- | -------: | ------- | ----------- | -------------------------- |
| notification_id | uuid        | NOT NULL |         | PK part     | FK(notifications.id)       |
| user_id         | uuid        | NOT NULL |         | PK part     | FK(users.id)               |
| is_read         | boolean     | NOT NULL | false   |             | Trạng thái đã đọc hay chưa |
| read_at         | timestamptz |     NULL |         |             | Thời điểm đọc              |

**Index khuyến nghị:**

- `notification_recipients(user_id, is_read, notification_id)` để query unread nhanh
- `notifications(org_id, created_at desc)`
- `notifications(org_id, project_id, created_at desc)`

**Lưu ý triển khai:**

- Sinh notifications từ các event nghiệp vụ (task_assignees insert, task status DONE, subtask is_done=true, comment insert, lock/unlock, report submit…).
- **US-MNG-07-03 (bật/tắt theo dự án):** trước khi sinh notification cho project, cần kiểm tra cấu hình theo project (bảng `project_notification_settings` bên dưới).
- Retention: giữ 90–180 ngày (tuỳ nhu cầu), có thể cleanup theo `created_at`.

---

#### 3.3.5. `project_notification_settings` (cấu hình bật/tắt theo dự án)

**Mô tả:** PM/MNG cấu hình bật/tắt một số loại thông báo **theo từng project** để tránh nhiễu (US-MNG-07-03).  
Thiết kế này là “project-wide” (áp dụng cho toàn bộ thành viên trong project). Nếu sau này cần per-user preference thì bổ sung thêm bảng user override.

| Column            | Type        |     Null | Default | Constraints  | Comment                                   |
| ----------------- | ----------- | -------: | ------- | ------------ | ----------------------------------------- |
| org_id            | uuid        | NOT NULL |         | PK part      | ID tổ chức                                |
| project_id        | uuid        | NOT NULL |         | PK part      | ID dự án                                  |
| notification_type | varchar(50) | NOT NULL |         | PK part      | Loại thông báo (COMMENT, SUBTASK_DONE, …) |
| is_enabled        | boolean     | NOT NULL | true    |              | Bật/tắt loại thông báo trong project      |
| updated_at        | timestamptz | NOT NULL | now     |              | Thời điểm cập nhật                        |
| updated_by        | uuid        |     NULL |         | FK(users.id) | Ai cập nhật (PM/MNG)                      |

**Constraints/Index:**

- PK: `(org_id, project_id, notification_type)`
- FK: `(org_id, project_id) -> projects(org_id, id)`
- Index (tuỳ): `(org_id, project_id, is_enabled)`

---

### 3.4. Nhóm Reporting (báo cáo + phản hồi + reaction)

#### 3.4.1. `reports`

**Mô tả:** Báo cáo tuần/tháng/quý (EMP-03). CEO/PM đọc, comment, reaction (CEO-03, MNG-04-03).

| Column       | Type         |     Null | Default     | Constraints  | Comment                                |
| ------------ | ------------ | -------: | ----------- | ------------ | -------------------------------------- |
| id           | uuid         | NOT NULL | gen         | PK           | ID báo cáo                             |
| org_id       | uuid         | NOT NULL |             |              | ID tổ chức                             |
| submitted_by | uuid         | NOT NULL |             | FK(users.id) | Nhân viên gửi báo cáo                  |
| period_type  | varchar(20)  | NOT NULL |             | CK           | Loại báo cáo: WEEK, MONTH, QUARTER     |
| period_start | date         | NOT NULL |             |              | Ngày bắt đầu chu kỳ                    |
| period_end   | date         | NOT NULL |             |              | Ngày kết thúc chu kỳ                   |
| title        | varchar(255) | NOT NULL |             |              | Tiêu đề báo cáo                        |
| content      | text         | NOT NULL |             |              | Nội dung báo cáo                       |
| status       | varchar(30)  | NOT NULL | `SUBMITTED` | CK           | Trạng thái: DRAFT, SUBMITTED, APPROVED |
| created_at   | timestamptz  | NOT NULL | now         |              | Thời điểm tạo báo cáo                  |
| updated_at   | timestamptz  | NOT NULL | now         |              | Thời điểm cập nhật cuối cùng           |
| deleted_at   | timestamptz  |     NULL |             |              | Thời điểm xóa (Soft delete)            |

**Constraints:**

- Unique: `(org_id, submitted_by, period_type, period_start, period_end)` (nếu 1 người chỉ 1 report/kỳ)
- Check: `period_end >= period_start`
- Check: `period_type IN ('WEEK','MONTH','QUARTER')`
- Check: `status IN ('DRAFT','SUBMITTED','APPROVED')`

---

#### 3.4.2. `report_comments`

**Mô tả:** Comment chỉ đạo/nhận xét (EMP-03-03, CEO-03-03).

| Column         | Type        |     Null | Default | Constraints  | Comment                        |
| -------------- | ----------- | -------: | ------- | ------------ | ------------------------------ |
| id             | uuid        | NOT NULL | gen     | PK           | ID bản ghi                     |
| org_id         | uuid        | NOT NULL |         |              | ID tổ chức                     |
| report_id      | uuid        | NOT NULL |         | FK(reports)  | ID báo cáo (org_id, report_id) |
| author_user_id | uuid        | NOT NULL |         | FK(users.id) | Người bình luận (Leader/CEO)   |
| comment_text   | text        | NOT NULL |         |              | Nội dung chỉ đạo/nhận xét      |
| created_at     | timestamptz | NOT NULL | now     |              | Thời điểm tạo bình luận        |
| deleted_at     | timestamptz |     NULL |         |              | Thời điểm xóa (Soft delete)    |

Constraints:

- Unique: `(org_id, id)`
- FK: `(org_id, report_id) -> reports(org_id, id)`

---

#### 3.4.3. `report_reactions`

**Mô tả:** Reaction (CEO-03-02).

| Column        | Type        |     Null | Default | Constraints           | Comment                      |
| ------------- | ----------- | -------: | ------- | --------------------- | ---------------------------- |
| org_id        | uuid        | NOT NULL |         | PK part               | ID tổ chức                   |
| report_id     | uuid        | NOT NULL |         | PK part, FK(reports)  | ID báo cáo                   |
| user_id       | uuid        | NOT NULL |         | PK part, FK(users.id) | Người thả reaction (CEO)     |
| reaction_code | varchar(30) | NOT NULL |         |                       | Mã cảm xúc: LIKE, CLAP, v.v. |
| created_at    | timestamptz | NOT NULL | now     |                       | Thời điểm thả reaction       |

Constraints:

- PK: `(org_id, report_id, user_id, reaction_code)` (cho phép nhiều loại)

---

### 3.5. Nhóm Finance (level/salary/cost rate)

#### 3.5.1. `job_levels`

**Mô tả:** Danh mục bậc/level trong Org (US-MNG-03-02, US-CEO-02-01).

| Column     | Type         |     Null | Default | Constraints | Comment                    |
| ---------- | ------------ | -------: | ------- | ----------- | -------------------------- |
| id         | uuid         | NOT NULL | gen     | PK          | ID bản ghi                 |
| org_id     | uuid         | NOT NULL |         |             | ID tổ chức                 |
| code       | varchar(50)  | NOT NULL |         |             | Mã bậc (J1, J2, Senior...) |
| name       | varchar(100) | NOT NULL |         |             | Tên bậc hiển thị           |
| sort_order | int          | NOT NULL | 0       |             | Dùng để so sánh cấp độ     |
| created_at | timestamptz  | NOT NULL | now     |             | Thời điểm tạo bản ghi      |

Constraints:

- Unique: `(org_id, code)`

---

#### 3.5.2. `employee_compensations`

**Mô tả:** Lương/cost-rate theo thời gian (effective dating) phục vụ chi phí dự án (MNG-03-03).

| Column           | Type          |     Null | Default | Constraints    | Comment                         |
| ---------------- | ------------- | -------: | ------- | -------------- | ------------------------------- |
| id               | uuid          | NOT NULL | gen     | PK             | ID bản ghi                      |
| org_id           | uuid          | NOT NULL |         |                | ID tổ chức                      |
| user_id          | uuid          | NOT NULL |         | FK(users.id)   | Nhân sự nhận lương              |
| level_id         | uuid          |     NULL |         | FK(job_levels) | Cấp bậc hiện tại                |
| currency         | char(3)       | NOT NULL | `VND`   |                | Đơn vị tiền tệ (ISO-4217)       |
| monthly_salary   | numeric(18,2) |     NULL |         | CK             | Lương tháng cố định (>= 0)      |
| hourly_cost_rate | numeric(18,2) |     NULL |         | CK             | Chi phí trên mỗi giờ (>= 0)     |
| effective_from   | date          | NOT NULL |         |                | Ngày bắt đầu áp dụng            |
| effective_to     | date          |     NULL |         |                | Ngày kết thúc (NULL = hiện tại) |
| created_at       | timestamptz   | NOT NULL | now     |                | Thời điểm tạo bản ghi           |
| created_by       | uuid          |     NULL |         | FK(users.id)   | ID người phê duyệt              |

Constraints:

- Unique: `(org_id, user_id, effective_from)` (hoặc unique range tuỳ DBMS)
- Check: `monthly_salary IS NULL OR monthly_salary >= 0`
- Check: `hourly_cost_rate IS NULL OR hourly_cost_rate >= 0`

---

#### 3.5.3. `user_contracts`

**Mô tả:** Hợp đồng nhân sự (US-CEO-02-03).

| Column          | Type         |     Null | Default  | Constraints          | Comment                                         |
| --------------- | ------------ | -------: | -------- | -------------------- | ----------------------------------------------- |
| id              | uuid         | NOT NULL | gen      | PK                   | ID hợp đồng                                     |
| org_id          | uuid         | NOT NULL |          | FK(organizations.id) | ID tổ chức                                      |
| user_id         | uuid         | NOT NULL |          | FK(users.id)         | Nhân sự ký hợp đồng                             |
| contract_number | varchar(100) | NOT NULL |          | UQ                   | Số số hợp đồng (pháp lý)                        |
| contract_type   | varchar(50)  | NOT NULL |          |                      | Loại: Thử việc, Chính thức, Thời vụ             |
| signed_date     | date         | NOT NULL |          |                      | Ngày ký kết                                     |
| effective_date  | date         | NOT NULL |          |                      | Ngày hợp đồng có hiệu lực                       |
| expiry_date     | date         |     NULL |          |                      | Ngày hết hạn hợp đồng (NULL nếu không thời hạn) |
| status          | varchar(30)  | NOT NULL | `ACTIVE` |                      | Trạng thái: ACTIVE, EXPIRED, TERMINATED         |
| document_id     | uuid         |     NULL |          | FK(documents.id)     | Liên kết tới file hợp đồng đã scan (documents)  |
| created_at      | timestamptz  | NOT NULL | now      |                      | Thời điểm tạo bản ghi                           |
| created_by      | uuid         |     NULL |          | FK(users.id)         | ID người tạo                                    |

---

### 3.6. Nhóm Assets/Links (tài liệu, sheet, git, deploy)

#### 3.6.1. `documents`

**Mô tả:** Tài liệu/form mẫu (upload/share/preview) (MNG-05-01).

| Column           | Type          |     Null | Default    | Constraints  | Comment                             |
| ---------------- | ------------- | -------: | ---------- | ------------ | ----------------------------------- |
| id               | uuid          | NOT NULL | gen        | PK           | ID bản ghi                          |
| org_id           | uuid          | NOT NULL |            |              | ID tổ chức                          |
| title            | varchar(255)  | NOT NULL |            |              | Tên tài liệu/form mẫu               |
| doc_type         | varchar(30)   | NOT NULL | `TEMPLATE` |              | Loại: TEMPLATE, FORM, FILE          |
| storage_provider | varchar(30)   |     NULL |            |              | Nhà cung cấp lưu trữ (S3, Local...) |
| storage_key      | varchar(1024) |     NULL |            |              | Đường dẫn vật lý của tệp            |
| mime_type        | varchar(100)  |     NULL |            |              | Định dạng tệp                       |
| file_size_bytes  | bigint        |     NULL |            |              | Dung lượng tệp                      |
| url              | text          |     NULL |            |              | Link truy cập nếu là link ngoài     |
| created_at       | timestamptz   | NOT NULL | now        |              | Thời điểm tạo bản ghi               |
| created_by       | uuid          | NOT NULL |            | FK(users.id) | ID người tạo                        |
| deleted_at       | timestamptz   |     NULL |            |              | Thời điểm xóa (Soft delete)         |

---

#### 3.6.2. `project_resources`

**Mô tả:** Link mô tả dữ liệu/quy trình, git, deploy, hoặc upload code (MNG-05-02/03/04).

|               | Column       | Type     | Null | Default       | Constraints                                 | Comment |
| ------------- | ------------ | -------- | ---: | ------------- | ------------------------------------------- | ------- |
| id            | uuid         | NOT NULL |  gen | PK            | ID bản ghi                                  |
| org_id        | uuid         | NOT NULL |      |               | ID tổ chức                                  |
| project_id    | uuid         | NOT NULL |      | FK(projects)  | ID dự án                                    |
| resource_type | varchar(30)  | NOT NULL |      | CK            | Loại: SHEET, GIT, DEPLOY, DOC, CODE_ARCHIVE |
| name          | varchar(255) | NOT NULL |      |               | Tên gợi nhớ                                 |
| url           | text         | NULL     |      |               | Link dẫn tới tài nguyên                     |
| document_id   | uuid         | NULL     |      | FK(documents) | Liên kết tới bảng documents (nếu có)        |
| notes         | text         | NULL     |      |               | Ghi chú cách dùng                           |
| created_at    | timestamptz  | NOT NULL |  now |               | Thời điểm tạo bản ghi                       |
| created_by    | uuid         | NOT NULL |      | FK(users.id)  | ID người tạo                                |

**Constraints:**

- FK: `(org_id, project_id) -> projects(org_id, id)`
- Check: `resource_type IN ('SHEET','GIT','DEPLOY','DOC','CODE_ARCHIVE')`

---

#### 3.6.3. `task_attachments` và `subtask_attachments`

**Mô tả:** Đính kèm file vào task và subtask (US-EMP-01-06, US-MNG-01-05).

`task_attachments`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| org_id | uuid | NOT NULL | | PK part | |
| task_id | uuid | NOT NULL | | PK part, FK(tasks) | |
| document_id | uuid | NOT NULL | | PK part, FK(documents.id) | |
| created_at | timestamptz | NOT NULL | now | | |
| created_by | uuid | NOT NULL | | FK(users.id) | |

`subtask_attachments`:
| Column | Type | Null | Default | Constraints | Comment |
| --- | --- | ---: | --- | --- | --- |
| org_id | uuid | NOT NULL | | PK part | |
| subtask_id | uuid | NOT NULL | | PK part, FK(subtasks.id) | |
| document_id | uuid | NOT NULL | | PK part, FK(documents.id) | |
| created_at | timestamptz | NOT NULL | now | | |
| created_by | uuid | NOT NULL | | FK(users.id) | |

---

### 3.7. Schema phân quyền (RBAC + scope)

#### 3.7.1. `roles`

**Mô tả:** Role có thể ở cấp Platform hoặc Tenant; Tenant role có thể “override” theo Org (ORG-02-03).

| Column     | Type         |     Null | Default | Constraints          | Comment                                         |
| ---------- | ------------ | -------: | ------- | -------------------- | ----------------------------------------------- |
| id         | uuid         | NOT NULL | gen     | PK                   | ID vai trò                                      |
| scope_type | varchar(20)  | NOT NULL |         | CK                   | Phạm vi vai trò: PLATFORM, TENANT               |
| org_id     | uuid         |     NULL |         | FK(organizations.id) | ID tổ chức sở hữu vai trò (NULL nếu PLATFORM)   |
| code       | varchar(50)  | NOT NULL |         |                      | Mã vai trò (SYS_ADMIN, ORG_ADMIN, CEO, PM, EMP) |
| name       | varchar(100) | NOT NULL |         |                      | Tên hiển thị vai trò                            |
| is_system  | boolean      | NOT NULL | false   |                      | Đánh dấu vai trò mặc định của hệ thống          |
| created_at | timestamptz  | NOT NULL | now     |                      | Thời điểm tạo bản ghi                           |
| created_by | uuid         |     NULL |         | FK(users.id)         | ID người tạo                                    |

Constraints:

- Unique: `(scope_type, org_id, code)` (org_id NULL hợp lệ cho platform)
- Check: `scope_type IN ('PLATFORM','TENANT')`

---

#### 3.7.2. `permissions`

**Mô tả:** Permission chuẩn Action_Resource (theo tài liệu phân quyền P01..P13).

| Column      | Type         |     Null | Default | Constraints | Comment                                            |
| ----------- | ------------ | -------: | ------- | ----------- | -------------------------------------------------- |
| id          | uuid         | NOT NULL | gen     | PK          | ID quyền                                           |
| code        | varchar(100) | NOT NULL |         | UQ          | Mã quyền (Dạng Action_Resource: MANAGE_PROJECT...) |
| description | varchar(500) | NOT NULL |         |             | Mô tả chi tiết quyền hạn                           |
| created_at  | timestamptz  | NOT NULL | now     |             | Thời điểm tạo bản ghi                              |

---

#### 3.7.3. `role_permissions`

**Mô tả:** N-N role ↔ permission.

| Column        | Type        |     Null | Default | Constraints              | Comment            |
| ------------- | ----------- | -------: | ------- | ------------------------ | ------------------ |
| role_id       | uuid        | NOT NULL |         | PK part, FK(roles)       | ID vai trò         |
| permission_id | uuid        | NOT NULL |         | PK part, FK(permissions) | ID quyền tương ứng |
| granted_at    | timestamptz | NOT NULL | now     |                          | Ngày cấp quyền     |
| granted_by    | uuid        |     NULL |         | FK(users.id)             | ID người cấp quyền |

Constraints:

- PK: `(role_id, permission_id)`

---

#### 3.7.4. `user_roles`

**Mô tả:** Gán role cho user theo scope (Org-wide hoặc Project-based).

| Column     | Type        |     Null | Default | Constraints          | Comment                                           |
| ---------- | ----------- | -------: | ------- | -------------------- | ------------------------------------------------- |
| id         | uuid        | NOT NULL | gen     | PK                   | ID bản ghi                                        |
| org_id     | uuid        |     NULL |         | FK(organizations.id) | ID tổ chức (NULL nếu là System Admin)             |
| project_id | uuid        |     NULL |         | FK(projects)         | ID dự án cụ thể (nếu gán role theo Project scope) |
| user_id    | uuid        | NOT NULL |         | FK(users.id)         | ID người dùng được gán role                       |
| role_id    | uuid        | NOT NULL |         | FK(roles.id)         | ID vai trò được gán                               |
| granted_at | timestamptz | NOT NULL | now     |                      | Thời điểm gán role                                |
| granted_by | uuid        |     NULL |         | FK(users.id)         | ID người thực hiện gán                            |
| revoked_at | timestamptz |     NULL |         |                      | Ngày thu hồi role                                 |
| revoked_by | uuid        |     NULL |         | FK(users.id)         | ID người thực hiện thu hồi                        |

Constraints:

- Unique (khuyến nghị): `(org_id, project_id, user_id, role_id, revoked_at IS NULL)` (tuỳ DBMS)
- Rule: nếu `project_id` NOT NULL thì `(org_id, project_id)` phải tồn tại và user phải là `project_members`.

---

### 3.8. Audit / Logging / Impersonation

#### 3.8.1. `impersonation_sessions`

**Mô tả:** Ghi nhận phiên “đăng nhập dưới quyền” (SYS-01-06) — bắt buộc để compliance.

| Column          | Type         |     Null | Default | Constraints          | Comment                         |
| --------------- | ------------ | -------: | ------- | -------------------- | ------------------------------- |
| id              | uuid         | NOT NULL | gen     | PK                   | ID bản ghi                      |
| org_id          | uuid         |     NULL |         | FK(organizations.id) | Org bị can thiệp hỗ trợ         |
| actor_user_id   | uuid         | NOT NULL |         | FK(users.id)         | System Admin thực hiện hỗ trợ   |
| subject_user_id | uuid         | NOT NULL |         | FK(users.id)         | User được hỗ trợ                |
| reason          | text         | NOT NULL |         |                      | Lý do cần đăng nhập dưới quyền  |
| started_at      | timestamptz  | NOT NULL | now     |                      | Thời điểm bắt đầu               |
| ended_at        | timestamptz  |     NULL |         |                      | Thời điểm kết thúc              |
| ended_reason    | text         |     NULL |         |                      | Lý do kết thúc phiên            |
| request_id      | varchar(100) |     NULL |         |                      | ID correlation để truy vết logs |

---

#### 3.8.2. `audit_logs`

**Mô tả:** Audit trail toàn hệ thống (SYS-02-02) + bắt buộc cho impersonation.

| Column                   | Type         |     Null | Default | Constraints                | Comment                              |
| ------------------------ | ------------ | -------: | ------- | -------------------------- | ------------------------------------ |
| id                       | uuid         | NOT NULL | gen     | PK                         | ID bản ghi                           |
| occurred_at              | timestamptz  | NOT NULL | now     |                            | Thời điểm xảy ra hành động           |
| org_id                   | uuid         |     NULL |         | FK(organizations.id)       | Hành động thuộc Org nào              |
| actor_user_id            | uuid         |     NULL |         | FK(users.id)               | Ai thực hiện                         |
| impersonation_session_id | uuid         |     NULL |         | FK(impersonation_sessions) | Nếu trong phiên hỗ trợ               |
| action                   | varchar(100) | NOT NULL |         |                            | Hành động: CREATE, UPDATE, DELETE... |
| entity_type              | varchar(100) | NOT NULL |         |                            | Loại đối tượng bị tác động           |
| entity_id                | uuid         |     NULL |         |                            | ID của đối tượng bị tác động         |
| before_data              | jsonb        |     NULL |         |                            | Dữ liệu cũ (Snapshot)                |
| after_data               | jsonb        |     NULL |         |                            | Dữ liệu mới                          |
| ip_address               | varchar(64)  |     NULL |         |                            | Địa chỉ IP                           |
| user_agent               | text         |     NULL |         |                            | Thông tin thiết bị                   |
| request_id               | varchar(100) |     NULL |         |                            | ID yêu cầu                           |

**Index khuyến nghị:** `(org_id, occurred_at desc)`, `(actor_user_id, occurred_at desc)`, `(entity_type, entity_id)`.

---

#### 3.8.3. `recycle_bin_items`

**Mô tả:** Bảng metadata trung tâm phục vụ hiển thị danh sách Thùng rác tập trung cho UI (US-EMP-06-01, US-MNG-08-01...).

| Column        | Type         | Null     | Default | Constraints  | Comment                                     |
| :------------ | :----------- | :------- | :------ | :----------- | :------------------------------------------ |
| id            | uuid         | NOT NULL | gen     | PK           |                                             |
| org_id        | uuid         | NOT NULL |         |              | ID tổ chức                                  |
| project_id    | uuid         | NULL     |         | FK(projects) | Project liên quan (nếu có)                  |
| entity_type   | varchar(50)  | NOT NULL |         |              | TASK, SUBTASK, PROJECT, DOCUMENT, ...       |
| entity_id     | uuid         | NOT NULL |         |              | ID của bản ghi bị xóa                       |
| entity_title  | varchar(500) | NOT NULL |         |              | Tiêu đề/Tên bản ghi tại thời điểm xóa       |
| deleted_at    | timestamptz  | NOT NULL | now     |              | Thời điểm xóa                               |
| deleted_by    | uuid         | NOT NULL |         | FK(users)    | Người thực hiện xóa                         |
| original_data | jsonb        | NULL     |         |              | (Tùy chọn) Snapshot dữ liệu cũ để khôi phục |

**Index:** `(org_id, deleted_at desc)`, `(org_id, project_id, deleted_at desc)`.

---

#### 3.8.4. `personal_tasks`

**Mô tả:** Task cá nhân/riêng tư của người dùng (US-EMP-07-x). Không phụ thuộc project, dùng cho Kanban Board cá nhân.

| Column        | Type         | Null     | Default  | Constraints              | Comment                                   |
| :------------ | :----------- | :------- | :------- | :----------------------- | :---------------------------------------- |
| id            | uuid         | NOT NULL | gen      | PK                       | ID task cá nhân                           |
| user_id       | uuid         | NOT NULL |          | FK(users.id)             | Chủ sở hữu task                           |
| org_id        | uuid         | NOT NULL |          | FK(organizations.id)     | Org của user (để isolation)               |
| title         | varchar(500) | NOT NULL |          |                          | Tiêu đề task                              |
| description   | text         | NULL     |          |                          | Mô tả chi tiết                            |
| status_code   | varchar(30)  | NOT NULL | 'TODO'   | FK(task_statuses.code)   | Trạng thái Kanban (TODO/IN_PROGRESS/DONE) |
| priority_code | varchar(30)  | NOT NULL | 'MEDIUM' | FK(task_priorities.code) | Độ ưu tiên                                |
| due_date      | date         | NULL     |          |                          | Hạn chót                                  |
| sort_order    | int          | NOT NULL | 0        |                          | Thứ tự sắp xếp trên Kanban Board          |
| created_at    | timestamptz  | NOT NULL | now      |                          |                                           |
| updated_at    | timestamptz  | NOT NULL | now      |                          |                                           |

**Index:** `(user_id, status_code, sort_order)`.

---

### 3.9. Nhóm Custom Fields (Task/Subtask)

#### 3.9.1. `custom_field_definitions`

**Mô tả:** Định nghĩa các trường dữ liệu bổ sung do Org Admin thiết lập (US-ORG-03-04).

| Column         | Type         | Null     | Default | Constraints       | Comment                           |
| :------------- | :----------- | :------- | :------ | :---------------- | :-------------------------------- |
| id             | uuid         | NOT NULL | gen     | PK                |                                   |
| org_id         | uuid         | NOT NULL |         | FK(organizations) |                                   |
| project_id     | uuid         | NOT NULL |         | FK(projects)      | ID dự án sở hữu trường tùy chỉnh  |
| entity_type    | varchar(20)  | NOT NULL |         | CK                | TASK, SUBTASK                     |
| field_name     | varchar(100) | NOT NULL |         |                   | Tên trường (VD: "Mã Jira")        |
| field_type     | varchar(20)  | NOT NULL |         | CK                | TEXT, NUMBER, DATE, SELECT        |
| select_options | jsonb        | NULL     |         |                   | Danh sách options cho loại SELECT |
| is_required    | boolean      | NOT NULL | false   |                   | Bắt buộc nhập hay không           |
| created_at     | timestamptz  | NOT NULL | now     |                   |                                   |
| created_by     | uuid         | NULL     |         | FK(users)         |                                   |

**Constraints:**

- Unique: `(org_id, project_id, entity_type, field_name)`
- FK: `(org_id, project_id) -> projects(org_id, id)`
- Check: `entity_type IN ('TASK', 'SUBTASK')`
- Check: `field_type IN ('TEXT', 'NUMBER', 'DATE', 'SELECT')`

---

#### 3.9.2. `custom_field_values`

**Mô tả:** Lưu trữ giá trị thực tế của các custom field cho từng task/subtask.

| Column      | Type | Null     | Default | Constraints              | Comment                           |
| :---------- | :--- | :------- | :------ | :----------------------- | :-------------------------------- |
| org_id      | uuid | NOT NULL |         | PK part                  |                                   |
| field_id    | uuid | NOT NULL |         | PK part, FK(definitions) |                                   |
| entity_id   | uuid | NOT NULL |         | PK part                  | ID của Task hoặc Subtask          |
| field_value | text | NULL     |         |                          | Giá trị (Lưu dạng text/serialize) |

**Constraints:**

- PK: `(org_id, field_id, entity_id)`

#### 3.9.3. `project_field_user_permissions` (Ma trận quyền Field - User)

**Mô tả:** Chỉ định cụ thể User được sửa Field nào của thực thể nào (Task hay Subtask) trong Project.

| Column          | Type         |   Null   | Default | Constraints           | Comment                       |
| :-------------- | :----------- | :------: | :------ | :-------------------- | :---------------------------- |
| org_id          | uuid         | NOT NULL |         | PK part               |                               |
| project_id      | uuid         | NOT NULL |         | PK part, FK(projects) |                               |
| user_id         | uuid         | NOT NULL |         | PK part, FK(users)    |                               |
| **entity_type** | varchar(20)  | NOT NULL |         | PK part, CK           | **'TASK'** hoặc **'SUBTASK'** |
| field_name      | varchar(100) | NOT NULL |         | PK part               | Tên cột hoặc ID Custom Field  |
| created_at      | timestamptz  | NOT NULL | now     |                       |                               |
| created_by      | uuid         |   NULL   |         | FK(users)             | PM thực hiện cấp quyền        |

---

## 4. Mô hình ERD tổng thể (ASCII)

> Ký hiệu: `1---n`, `n---n` (qua bảng junction), mũi tên thể hiện FK.

```text
organizations 1---n projects 1---n tasks 1---n subtasks
     |                |          |           |
     |                |          n---n users (task_assignees)
     |                |          |           |
     |                |          n---n tags  (task_tags)
     |                |          |           |
     |                |          n---n docs  (task_attachments)
     |                |          |           |
     |                |          n---n projects (custom_field_definitions)
     |                |          |           |
     |                |          1---n task_comments
     |                |                      |
     |                |                      n---n docs (subtask_attachments)
     |                |                      |
     |                |                      n---n cf_defs (custom_field_values)
     |                |                      |
     |                |                      1---n subtask_comments
     |                |
     |                n---n users (project_members)
     |
     1---n org_memberships n---1 users

users 1---n reports 1---n report_comments
users n---n reports (report_reactions)

projects 1---n work_period_locks
projects 1---n custom_field_definitions
tasks 1---n time_logs (owner_user_id -> users)
tasks 1---n custom_field_values
subtasks 1---n time_logs (subtask_id -> subtasks)
subtasks 1---n custom_field_values

users 1---n activity_events (actor_user_id -> users)
projects 1---n activity_events
organizations 1---n activity_events

notifications 1---n notification_recipients
users 1---n notification_recipients
projects 1---n notifications
organizations 1---n notifications

organizations 1---n job_levels 1---n employee_compensations (user_id -> users)

roles n---n permissions (role_permissions)
users n---n roles (user_roles) [scope: org_id/project_id]

impersonation_sessions 1---n audit_logs
organizations/users/... 1---n audit_logs (entity references)
```

### 4.1. Chuẩn hoá tới 3NF (tóm tắt)

- **1NF**: mọi thuộc tính atomic; không nhồi danh sách (assignees/tags tách bảng).
- **2NF**: bảng junction dùng PK tổng hợp; thuộc tính phụ thuộc đầy đủ vào PK.
- **3NF**: thuộc tính không khoá không phụ thuộc bắc cầu vào khoá.
  - Danh mục status/priority/type tách lookup để không phụ thuộc vào mô tả text.
  - Lương theo thời gian tách `employee_compensations` (effective dating).
  - RBAC tách `roles`, `permissions`, `role_permissions`, `user_roles`.

---

## 5. Schema phân quyền (RBAC/ABAC) — linkage Org/Project

### 5.1. Bảng bắt buộc

- `roles`
- `permissions`
- `role_permissions`
- `user_roles`

### 5.2. Data scope linkage

- **Org scope**: `user_roles.org_id IS NOT NULL AND project_id IS NULL`
- **Project scope**: `user_roles.project_id IS NOT NULL` (đồng thời user phải là `project_members`)
- **System admin**: role có `scope_type=PLATFORM` và `org_id IS NULL`

### 5.3. ABAC (policy-level, không chỉ RBAC)

Các “attribute” tối thiểu cần tồn tại trong dữ liệu để enforce:

- **Ownership**:
  - `subtasks.created_by`
  - `time_logs.owner_user_id` (và/hoặc `created_by`)
- **Temporal lock**:
  - `work_period_locks.is_locked` theo `(org_id, project_id, work_date ∈ [period_start, period_end])`
- **Project membership**:
  - `project_members` để giới hạn PM scope và quyền thao tác theo dự án

---

## 6. Mapping các bảng với từng Epic / User Story

### 6.1. EMP (Employee)

- **EMP-01 (Task cá nhân)**
  - Bảng: `tasks`, `task_assignees`, `subtasks`, `tags`, `task_tags`, lookup `task_statuses/task_priorities`
  - Field bắt buộc: `tasks.status_code`, `tasks.priority_code`, `task_assignees.user_id`, `subtasks.created_by`
- **EMP-02 (Time log)**
  - Bảng: `time_logs`, `work_period_locks`
  - Field bắt buộc: `time_logs.owner_user_id`, `time_logs.work_date`, `time_logs.minutes`, `work_period_locks.is_locked`
- **EMP-03 (Report + feedback)**
  - Bảng: `reports`, `report_comments`
  - Field bắt buộc: `reports.period_*`, `report_comments.author_user_id`
- **EMP-04 (Activity)**
  - Bảng: `activity_events`
  - Field bắt buộc: `activity_events.actor_user_id`, `activity_events.activity_date`, `activity_events.activity_type`
- **EMP-05 (Notifications)**
  - Bảng: `notifications`, `notification_recipients`
  - Field bắt buộc: `notification_recipients.user_id`, `notification_recipients.is_read`, `notifications.notification_type`

### 6.2. MNG (PM/CTO)

- **MNG-01 (Project & assignment)**
  - Bảng: `projects`, `project_members`, `tasks`, `task_assignees`, `custom_field_definitions`
- **MNG-02 (Dashboard)**
  - Nguồn: `tasks`, `time_logs`, `project_members`, (tùy) materialized view
- **MNG-09 (Biểu đồ Gantt)**
  - Bảng: `projects`, `tasks`, `subtasks`
  - Logic: X-axis (time), Y-axis (Task/Subtask hierarchy). Task/Subtask dates dùng để vẽ thanh Gantt.
- **MNG-03 (Resource & cost)**
  - Bảng: `job_levels`, `employee_compensations`, `time_logs`, `project_members`
- **MNG-04 (Lock cycle)**
  - Bảng: `work_period_locks`, `time_logs` (enforce), (tùy) audit log
- **MNG-05 (Assets/tech process)**
  - Bảng: `documents`, `project_resources`
- **MNG-06 (Activity - project scope)**
  - Bảng: `activity_events` (filter theo `project_id`)
- **MNG-07 (Notifications)**
  - Bảng: `notifications`, `notification_recipients` (filter theo `project_id`)

### 6.3. CEO

- **CEO-01 (Dashboard tổng quan)**
  - Nguồn: `projects`, `tasks`, `time_logs`, `reports`
- **CEO-02 (Lương/chi phí)**
  - Bảng: `employee_compensations`, `job_levels`, `time_logs`, `project_members`, `user_profiles`, `user_contracts`
- **CEO-03 (Đọc report + reaction/comment)**
  - Bảng: `reports`, `report_reactions`, `report_comments`
- **CEO-04 (Activity - org scope)**
  - Bảng: `activity_events` (filter theo `org_id`)
- **CEO-05 (Notifications)**
  - Bảng: `notifications`, `notification_recipients` (filter theo `org_id`)

### 6.4. SYS (System Admin)

- **SYS-01 (Org lifecycle, impersonate, master roles/permissions, quota)**
  - Bảng: `organizations`, `org_quotas`, `users`, `org_memberships`, `roles`, `permissions`, `role_permissions`, `user_roles`, `impersonation_sessions`, `audit_logs`
- **SYS-02 (Monitoring, Audit)**
  - Bảng: `audit_logs`

### 6.5. ORG (Org Admin)

- **ORG-01 (Employee lifecycle)**
  - Bảng: `org_memberships`, `org_invites`, `users`
- **ORG-02 (Internal RBAC)**
  - Bảng: `roles` (tenant-scoped), `permissions`, `role_permissions`, `user_roles`
- **ORG-03 (Workspace config)**
  - Bảng: `organizations` (timezone), `work_period_locks` (policy theo lịch), lookup tables mở rộng (tuỳ)
- **ORG-04 (Custom Fields)**
  - (Đã chuyển quyền cho PM - Xem MNG-01-10)

---

## 7. Audit Logging / Soft Delete / Versioning

### 7.1. Audit fields chung (khuyến nghị áp dụng cho đa số bảng)

- **`created_at`, `created_by`**
- **`updated_at`, `updated_by`**
- **`deleted_at`, `deleted_by`** (soft delete)
- **`row_version`** (optimistic concurrency; tăng khi update)

### 7.2. Cách ghi log thay đổi (khuyến nghị)

- **Application-level auditing**:
  - Ghi `audit_logs` trong cùng transaction khi CRUD nghiệp vụ quan trọng (task, time log, salary, role changes).
- **DB-level auditing (tuỳ chọn)**:
  - Trigger AFTER INSERT/UPDATE/DELETE trên các bảng quan trọng để ghi `audit_logs`.
  - Lưu ý: trigger cần “bối cảnh” actor/request_id → thường phải truyền qua session variables.

### 7.3. Soft delete rules

- Không “hard delete” các bảng lịch sử: `time_logs`, `reports`, `audit_logs` (cấm).
- Junction mapping có thể `CASCADE` khi parent delete logic (nhưng thực tế nên archive thay vì delete).

---

## 8. Indexes / Performance Considerations

### 8.1. Index quan trọng (gợi ý)

- `projects`: `(org_id, status)`, `(org_id, code)`
- `project_members`: `(org_id, user_id)`, `(org_id, project_id, member_role)`
- `tasks`:
  - `(org_id, project_id, status_code)`
  - `(org_id, project_id, priority_code)`
  - `(org_id, project_id, due_date)`
  - (tuỳ) full-text index cho `title/description`
- `task_assignees`: `(org_id, user_id, assigned_at)`, `(org_id, task_id)`
- `time_logs`:
  - `(org_id, owner_user_id, work_date)`
  - `(org_id, project_id, work_date)`
  - `(org_id, task_id, work_date)`
- `work_period_locks`: `(org_id, project_id, period_start, period_end)`; `(org_id, project_id, is_locked)`
- `reports`: `(org_id, submitted_by, period_start)`, `(org_id, period_type, period_start)`
- `audit_logs`: `(org_id, occurred_at desc)`, `(actor_user_id, occurred_at desc)`, `(entity_type, entity_id)`

### 8.2. Composite index cho query heavy

- Task list “của tôi” theo filter:
  - `task_assignees(org_id, user_id, task_id)` + `tasks(org_id, id, status_code, priority_code, due_date)`
- Dashboard % hoàn thành theo dự án:
  - `tasks(org_id, project_id, status_code)` (covering)

### 8.3. Partition / retention

- `audit_logs` và (tuỳ) `time_logs` có thể **partition theo tháng** (range by `occurred_at` / `work_date`) khi dữ liệu lớn.
- Retention policy:
  - Audit: giữ dài hạn (compliance).
  - Time log: giữ theo hợp đồng; thường 3–5 năm.

---

## 9. Data Integrity & Constraint

### 9.1. FK Cascade & Restrict Rules

Để đảm bảo tính toàn vẹn khi thực hiện **Hard Delete** (từ Recycle Bin), các quy tắc sau được áp dụng:

| Loại bảng      | Foreign Key từ                  | Tới bảng                 | Hành động           | Lý do                                     |
| :------------- | :------------------------------ | :----------------------- | :------------------ | :---------------------------------------- |
| **Phụ thuộc**  | `user_profiles`                 | `users`                  | `ON DELETE CASCADE` | Profile không tồn tại thiếu User.         |
| **Mapping**    | `role_permissions`              | `roles`, `permissions`   | `ON DELETE CASCADE` | Bảng trung gian cần dọn dẹp.              |
| **Mapping**    | `user_roles`                    | `roles`, `users`         | `ON DELETE CASCADE` | Gán role vô nghĩa nếu Role/User mất.      |
| **Thành viên** | `project_members`               | `projects`, `users`      | `ON DELETE CASCADE` |                                           |
| **Công việc**  | `subtasks`                      | `tasks`                  | `ON DELETE CASCADE` | Subtask thuộc về Task cha.                |
| **Gán việc**   | `task_assignees`                | `tasks`, `users`         | `ON DELETE CASCADE` |                                           |
| **Thảo luận**  | `task_comments`                 | `tasks`                  | `ON DELETE CASCADE` | Comment mất theo Task.                    |
| **Phụ trợ**    | `task_tags`, `task_attachments` | `tasks`                  | `ON DELETE CASCADE` |                                           |
| **Thông báo**  | `notification_recipients`       | `notifications`          | `ON DELETE CASCADE` |                                           |
| **Tài chính**  | `time_logs`                     | `tasks`, `projects`      | `RESTRICT`          | Chặn xóa Task nếu đã có log giờ làm việc. |
| **Audit**      | `audit_logs`                    | `users`, `organizations` | `NO ACTION`         | Giữ log truy vết vĩnh viễn.               |

_Lưu ý: Tất cả Foreign Keys đều kèm theo `ON UPDATE CASCADE` để đảm bảo tính nhất quán._

### 9.2. Check constraint (ví dụ)

- `time_logs.minutes > 0`
- `period_end >= period_start`
- `status`/`type` thuộc tập hợp hợp lệ (hoặc FK lookup)

### 9.3. Enum constraint

Hai lựa chọn:

- **Lookup tables** (đã thiết kế): dễ tuỳ biến.
- **DB enum**: nhanh, chặt, nhưng khó migrate khi đổi.

---

## 10. Multi-tenant Strategy

### 10.1. Shared schema hay isolated schema?

- Chọn **Shared schema**:
  - Ưu: vận hành đơn giản, tối ưu tài nguyên, dễ BI cross-tenant (cho System Admin).
  - Nhược: yêu cầu kiểm soát tenant isolation chặt (RLS/app-layer).

### 10.2. Tenant-aware key design

- Tất cả bảng tenant có `org_id`.
- FK giữa bảng tenant nên dùng composite `(org_id, id)` để chống cross-tenant bằng constraint.

### 10.3. Row-level security notes (khuyến nghị)

Nếu dùng PostgreSQL:

- Bật RLS cho bảng tenant.
- Policy: `org_id = current_setting('app.org_id')::uuid`
- System Admin bypass:
  - Dùng role DB đặc quyền hoặc set flag `app.is_sys_admin=true` và policy cho phép.

---

## 11. Phân quyền trên dữ liệu (Field-level / Row-level)

### 11.1. Row-level permission

- **Org scope**: filter theo `org_id`.
- **Project scope**: filter theo `project_members` và `project_id`.
- **Ownership**:
  - `subtasks.created_by = current_user_id`
  - `time_logs.owner_user_id = current_user_id`
- **Subtask Time Log Validation**:
  - Nếu `time_logs.subtask_id` NOT NULL, `subtask.task_id` phải bằng `time_logs.task_id`.

### 11.2. Field-level permission (ví dụ salary)

Salary/cost-rate là dữ liệu nhạy cảm:

- Chỉ user có permission `VIEW_SALARY_FINANCE` mới được đọc:
  - CEO/Org Admin: tenant-wide
  - PM: project-based (chỉ user thuộc dự án mình quản lý)
- Thiết kế dữ liệu hỗ trợ:
  - `employee_compensations` có `org_id`, `user_id` (join với `project_members` để hạn chế)

---

## 12. Migration & Seed Script Outline

### 12.1. Order of creation (khuyến nghị)

1. `organizations`, `org_quotas`
2. `users`, `org_memberships`, `org_invites`
3. `roles`, `permissions`, `role_permissions`, `user_roles`
4. Lookup: `task_statuses`, `task_priorities`, `task_types`
5. `projects`, `project_members`
6. `tasks`, `task_assignees`, `subtasks`, `tags`, `task_tags`
7. `work_period_locks`, `time_logs`
8. `reports`, `report_comments`, `report_reactions`
9. `documents`, `project_resources`
10. `job_levels`, `employee_compensations`
11. `impersonation_sessions`, `audit_logs`

### 12.2. Seed data (Role/Permission)

- Insert `permissions` theo danh sách:
  - `MANAGE_ORGANIZATION`, `IMPERSONATE_USER`, `MANAGE_ORG_USER`, `CONFIG_ORG_ROLE`,
  - `VIEW_ALL_DASHBOARD`, `VIEW_SALARY_FINANCE`, `MANAGE_PROJECT`, `ASSIGN_TASK`,
  - `LOCK_LOGTIME`, `CREATE_SUBTASK`, `LOG_TIME`, `MANAGE_ATTACHMENT`, `COMMENT_TASK`,
  - `SUBMIT_REPORT`, `INTERACT_REPORT`
- Insert `roles` mặc định:
  - Platform: `SYS_ADMIN`
  - Tenant: `ORG_ADMIN`, `CEO`, `PM`, `EMP`
- Insert `role_permissions` theo matrix trong tài liệu phân quyền (PM có `VIEW_SALARY_FINANCE` partial sẽ enforce bằng scope, không chỉ bằng RBAC).

---

## 13. Ví dụ query thiết kế (DB-agnostic SQL)

### 13.1. Lấy danh sách task “được giao cho tôi” trong Org, filter theo project + status + priority

```sql
SELECT
  t.id, t.title, t.status_code, t.priority_code, t.due_date, t.updated_at
FROM tasks t
JOIN task_assignees ta
  ON ta.org_id = t.org_id
 AND ta.task_id = t.id
WHERE t.org_id = :current_org_id
  AND ta.user_id = :current_user_id
  AND (:project_id IS NULL OR t.project_id = :project_id)
  AND (:status_code IS NULL OR t.status_code = :status_code)
  AND (:priority_code IS NULL OR t.priority_code = :priority_code)
  AND t.deleted_at IS NULL
ORDER BY t.due_date NULLS LAST, t.updated_at DESC;
```

### 13.2. Enforce scope theo Project (PM chỉ thấy project mình quản lý)

```sql
SELECT t.*
FROM tasks t
JOIN project_members pm
  ON pm.org_id = t.org_id
 AND pm.project_id = t.project_id
 AND pm.user_id = :current_user_id
WHERE t.org_id = :current_org_id
  AND pm.member_role = 'PM'
  AND t.deleted_at IS NULL;
```

### 13.3. Tính chi phí dự án theo thời gian làm Task (Task-based Costing)

-- Hệ thống tính tổng thời gian log của từng nhân sự cho mỗi Task rồi nhân với đơn giá.
-- Không tính riêng lẻ Subtask trong báo cáo chi phí để tránh phân mảnh dữ liệu.

```sql
SELECT
  tl.project_id,
  tl.task_id,
  tl.owner_user_id,
  SUM(tl.minutes) as total_task_minutes,
  SUM((tl.minutes / 60.0) * ec.hourly_cost_rate) AS task_cost_amount
FROM time_logs tl
JOIN employee_compensations ec
  ON ec.org_id = tl.org_id
 AND ec.user_id = tl.owner_user_id
 AND ec.effective_from <= tl.work_date
 AND (ec.effective_to IS NULL OR ec.effective_to >= tl.work_date)
WHERE tl.org_id = :current_org_id
  AND tl.project_id = :project_id
  AND tl.deleted_at IS NULL
GROUP BY tl.project_id, tl.task_id, tl.owner_user_id;
```

### 13.4. Check “locked period” để chặn update time log (logic minh hoạ)

-- Áp dụng cho cả task và subtask (vì subtask thuộc project thông qua task)

```sql
SELECT EXISTS (
  SELECT 1
  FROM work_period_locks wpl
  WHERE wpl.org_id = :current_org_id
    AND wpl.project_id = :project_id
    AND wpl.is_locked = TRUE
    AND :work_date BETWEEN wpl.period_start AND wpl.period_end
) AS is_locked;
```

---

## 14. Appendix

### 14.1. Glossary

- **Org / Organization / Tenant**: công ty khách hàng trong mô hình SaaS.
- **Project**: dự án thuộc Org.
- **RBAC**: phân quyền theo role.
- **ABAC**: phân quyền theo thuộc tính (ownership, thời gian, scope).
- **Soft delete**: không xoá vật lý; đánh dấu `deleted_at`.
- **Effective dating**: dữ liệu theo khoảng hiệu lực (lương theo thời gian).

### 14.2. Naming convention

- Table/column: `snake_case`, số ít hay số nhiều nhất quán (tài liệu dùng **số nhiều**: `projects`, `tasks`…).
- FK: `<ref>_id` (ví dụ `org_id`, `project_id`).
- Junction table: `<a>_<b>` hoặc tên nghiệp vụ (`task_assignees`, `role_permissions`).
- Timestamps: `*_at` (`created_at`, `updated_at`).

### 14.3. Data type guideline

- ID: `uuid` (khuyến nghị); nếu dùng `bigint` thì chuẩn hoá theo strategy ID.
- Tiền tệ: `numeric(18,2)` + `currency` (ISO-4217).
- Text dài: `text` (hoặc `varchar` có giới hạn khi cần).
- JSON: `jsonb` cho audit snapshots và metadata.
