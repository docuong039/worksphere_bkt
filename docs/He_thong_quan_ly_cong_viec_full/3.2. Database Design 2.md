## DATABASE DESIGN DOCUMENT — Phần mềm Quản lý Công việc Enterprise (SaaS Multi-tenant) (Phần 2)

**Vai trò thiết kế:** Database Architect / Data Modeler (Senior)  
**Phiên bản:** 1.0  
**Định hướng DBMS:** RDBMS (khuyến nghị PostgreSQL; tài liệu giữ mức “DB-agnostic” nơi có thể)

---

## 5. Schema phân quyền (RBAC/ABAC) — linkage Org/Project

### 5.1. Bảng bắt buộc (Bổ sung theo Phase 2)

- **RBAC Core**: `roles` (5 Role chính), `permissions`, `role_permissions`, `user_roles`.
- **Phân rã Auth**: `resources` (Danh mục 26 Resource codes), `actions` (Danh mục 17 Action codes).
- **Governance**: `policies` (Lưu 7 định nghĩa chính sách POL-\*) và `project_field_user_permissions` (Ma trận quyền Field-level).

### 5.2. Data scope linkage

- **Org scope**: `user_roles.org_id IS NOT NULL AND project_id IS NULL`. Áp dụng cho ORG_ADMIN, CEO.
- **Project scope**: `user_roles.project_id IS NOT NULL`. User phải là `project_members` (PROJECT_MANAGER / EMPLOYEE).
- **System admin**: role có `scope_type=PLATFORM` và `org_id IS NULL`. Bypass tenant filter cho PLATFORM resources.

### 5.3. ABAC (policy-level) — 9 Attributes bắt buộc

Để thực thi đầy đủ các chính sách tại tài liệu Phase 2, hệ thống cần các thuộc tính:

- **SaaS Isolation**: `org_id` (trên mọi bảng nghiệp vụ) để đảm bảo cô lập dữ liệu.
- **Ownership**: `subtasks.created_by`, `time_logs.owner_user_id`, `reports.submitted_by`.
- **Temporal lock**: `work_period_locks.is_locked` theo `(org_id, project_id, work_date)`.
- **Project Role**: `project_members.member_role` (PM/Member/Viewer).
- **Status Check**: `tasks.status_code` (Ví dụ: chặn Log time khi chưa DONE).
- **Field Level**: `project_field_user_permissions` (Linkage giữa User và từng cột dữ liệu).
- **Data Safety**: `deleted_at` (Soft-delete status) và `recycle_bin_items`.
- **Concurrency**: `row_version` (BIGINT) trên các bảng Task/TimeLog để chống race condition.
- **Life Cycle**: `org_memberships.member_status` (Chặn đăng nhập/thao tác nếu trạng thái NOT ACTIVE).

---

## 6. Mapping các bảng với từng Epic / User Story (Full 47 Tables)

### 6.1. EMP (Employee) — Tập trung thực thi & cá nhân hóa

- **EMP-01 (Task & Collaboration)**
  - Bảng: `tasks`, `task_assignees`, `subtasks`, `tags`, `task_tags`, `task_attachments`, `subtask_attachments`, `task_comments`, `subtask_comments`, `task_comment_mentions`, `subtask_comment_mentions`.
  - Lookup: `task_statuses`, `task_priorities`, `task_types`.
- **EMP-02 (Time log)**
  - Bảng: `time_logs`, `work_period_locks` (check constraint).
- **EMP-03 (Report & Feedback)**
  - Bảng: `reports`, `report_comments`.
- **EMP-04 (Activity & Notifications)**
  - Bảng: `activity_events`, `notifications`, `notification_recipients`.
- **EMP-06 & 07 (Self-Management)**
  - Bảng: `recycle_bin_items` (cá nhân), `personal_tasks` (Private Kanban).

### 6.2. MNG (Project Manager) — Tập trung quản lý & điều phối

- **MNG-01 (Project & Assignment)**
  - Bảng: `projects`, `project_members`, `tasks`, `task_assignees`.
- **MNG-01-10..13 (Customization & Permissions)**
  - Bảng: `custom_field_definitions`, `custom_field_values`, `project_field_user_permissions`.
- **MNG-04 & 05 (Governance & Resources)**
  - Bảng: `work_period_locks`, `documents`, `project_resources`.
- **MNG-07 (Smart Notifications)**
  - Bảng: `project_notification_settings`, `notifications`.
- **MNG-02 & 09 (Tracking)**
  - Nguồn dữ liệu: `tasks`, `subtasks`, `time_logs`, `activity_events`.

### 6.3. CEO (Executive) — Tập trung giám sát & tài chính

- **CEO-01..03 (Overview & Governance)**
  - Bảng: `projects`, `reports`, `report_reactions`, `report_comments`.
- **CEO-02 (Compensation & HR)**
  - Bảng: `job_levels`, `employee_compensations`, `user_contracts`, `user_profiles`, `org_memberships`.
- **CEO-04 & 05 (Audit & Awareness)**
  - Bảng: `activity_events` (Org scope), `notifications`.

### 6.4. SYS (System Admin) — Quản trị nền tảng (Platform Layer)

- **SYS-01 (Tenancy & Identity)**
  - Bảng: `organizations`, `org_quotas`, `users`, `impersonation_sessions`.
- **SYS-02 (System RBAC & Audit)**
  - Bảng: `roles`, `permissions`, `role_permissions`, `user_roles`, `audit_logs`.

### 6.5. ORG (Org Admin) — Quản trị nội bộ tổ chức (Tenant Layer)

- **ORG-01 (User Lifecycle)**
  - Bảng: `org_memberships`, `org_invites`, `users`.
- **ORG-02 & 03 (Internal Config)**
  - Bảng: `roles` (Tenant scope), `user_roles`, `organizations` (Settings), `work_period_locks`.

---

## 7. Audit Logging / Soft Delete / Versioning

### 7.1. Audit fields chung (khuyến nghị áp dụng cho đa số bảng)

- **`created_at`, `created_by`**
- **`updated_at`, `updated_by`**
- **`deleted_at`, `deleted_by`** (soft delete)
- **`row_version`** (optimistic concurrency; tăng khi update)

### 7.2. Cách ghi log thay đổi (khuyến nghị)

- **Application-level auditing**:
  - Ghi `audit_logs` trong cùng transaction khi CRUD nghiệp vụ quan trọng (task, time log, salary, role changes).
- **DB-level auditing (tuỳ chọn)**:
  - Trigger AFTER INSERT/UPDATE/DELETE trên các bảng quan trọng để ghi `audit_logs`.
  - Lưu ý: trigger cần “bối cảnh” actor/request_id → thường phải truyền qua session variables.

### 7.3. Soft delete rules

- Không “hard delete” các bảng lịch sử: `time_logs`, `reports`, `audit_logs` (cấm).
- Junction mapping có thể `CASCADE` khi parent delete logic (nhưng thực tế nên archive thay vì delete).

---

## 8. Indexes / Performance Considerations

### 8.1. Index quan trọng (gợi ý)

- `projects`: `(org_id, status)`, `(org_id, code)`
- `project_members`: `(org_id, user_id)`, `(org_id, project_id, member_role)`
- `tasks`:
  - `(org_id, project_id, status_code)`
  - `(org_id, project_id, priority_code)`
  - `(org_id, project_id, due_date)`
  - (tuỳ) full-text index cho `title/description`
- `task_assignees`: `(org_id, user_id, assigned_at)`, `(org_id, task_id)`
- `time_logs`:
  - `(org_id, owner_user_id, work_date)`
  - `(org_id, project_id, work_date)`
  - `(org_id, task_id, work_date)`
- `work_period_locks`: `(org_id, project_id, period_start, period_end)`; `(org_id, project_id, is_locked)`
- `reports`: `(org_id, submitted_by, period_start)`, `(org_id, period_type, period_start)`
- `audit_logs`: `(org_id, occurred_at desc)`, `(actor_user_id, occurred_at desc)`, `(entity_type, entity_id)`

### 8.2. Composite index cho query heavy

- Task list “của tôi” theo filter:
  - `task_assignees(org_id, user_id, task_id)` + `tasks(org_id, id, status_code, priority_code, due_date)`
- Dashboard % hoàn thành theo dự án:
  - `tasks(org_id, project_id, status_code)` (covering)

### 8.3. Partition / retention

- `audit_logs` và (tuỳ) `time_logs` có thể **partition theo tháng** (range by `occurred_at` / `work_date`) khi dữ liệu lớn.
- Retention policy:
  - Audit: giữ dài hạn (compliance).
  - Time log: giữ theo hợp đồng; thường 3–5 năm.

---

## 9. Data Integrity & Constraint

### 9.1. FK Cascade & Restrict Rules

Để đảm bảo tính toàn vẹn khi thực hiện **Hard Delete** (từ Recycle Bin), các quy tắc sau được áp dụng:

| Loại bảng      | Foreign Key từ                  | Tới bảng                 | Hành động           | Lý do                                     |
| :------------- | :------------------------------ | :----------------------- | :------------------ | :---------------------------------------- |
| **Phụ thuộc**  | `user_profiles`                 | `users`                  | `ON DELETE CASCADE` | Profile không tồn tại thiếu User.         |
| **Mapping**    | `role_permissions`              | `roles`, `permissions`   | `ON DELETE CASCADE` | Bảng trung gian cần dọn dẹp.              |
| **Mapping**    | `user_roles`                    | `roles`, `users`         | `ON DELETE CASCADE` | Gán role vô nghĩa nếu Role/User mất.      |
| **Thành viên** | `project_members`               | `projects`, `users`      | `ON DELETE CASCADE` |                                           |
| **Công việc**  | `subtasks`                      | `tasks`                  | `ON DELETE CASCADE` | Subtask thuộc về Task cha.                |
| **Gán việc**   | `task_assignees`                | `tasks`, `users`         | `ON DELETE CASCADE` |                                           |
| **Thảo luận**  | `task_comments`                 | `tasks`                  | `ON DELETE CASCADE` | Comment mất theo Task.                    |
| **Phụ trợ**    | `task_tags`, `task_attachments` | `tasks`                  | `ON DELETE CASCADE` |                                           |
| **Thông báo**  | `notification_recipient`        | `notifications`          | `ON DELETE CASCADE` |                                           |
| **Tài chính**  | `time_logs`                     | `tasks`, `projects`      | `RESTRICT`          | Chặn xóa Task nếu đã có log giờ làm việc. |
| **Audit**      | `audit_logs`                    | `users`, `organizations` | `NO ACTION`         | Giữ log truy vết vĩnh viễn.               |

_Lưu ý: Tất cả Foreign Keys đều kèm theo `ON UPDATE CASCADE` để đảm bảo tính nhất quán._

### 9.2. Check constraint (ví dụ)

- `time_logs.minutes > 0`
- `period_end >= period_start`
- `status`/`type` thuộc tập hợp hợp lệ (hoặc FK lookup)

### 9.3. Enum constraint

Hai lựa chọn:

- **Lookup tables** (đã thiết kế): dễ tuỳ biến.
- **DB enum**: nhanh, chặt, nhưng khó migrate khi đổi.

---

## 10. Multi-tenant Strategy

### 10.1. Shared schema hay isolated schema?

- Chọn **Shared schema**:
  - Ưu: vận hành đơn giản, tối ưu tài nguyên, dễ BI cross-tenant (cho System Admin).
  - Nhược: yêu cầu kiểm soát tenant isolation chặt (RLS/app-layer).

### 10.2. Tenant-aware key design

- Tất cả bảng tenant có `org_id`.
- FK giữa bảng tenant nên dùng composite `(org_id, id)` để chống cross-tenant bằng constraint.

### 10.3. Row-level security notes (khuyến nghị)

Nếu dùng PostgreSQL:

- Bật RLS cho bảng tenant.
- Policy: `org_id = current_setting('app.org_id')::uuid`
- System Admin bypass:
  - Dùng role DB đặc quyền hoặc set flag `app.is_sys_admin=true` và policy cho phép.

---

## 11. Phân quyền trên dữ liệu (Field-level / Row-level)

### 11.1. Row-level permission

- **Org scope**: filter theo `org_id`.
- **Project scope**: filter theo `project_members` và `project_id`.
- **Ownership**:
  - `subtasks.created_by = current_user_id`
  - `time_logs.owner_user_id = current_user_id`
- **Subtask Time Log Validation**:
  - Nếu `time_logs.subtask_id` NOT NULL, `subtask.task_id` phải bằng `time_logs.task_id`.

### 11.2. Field-level permission (ví dụ salary)

Salary/cost-rate là dữ liệu nhạy cảm:

- Chỉ user có permission `VIEW_SALARY_FINANCE` mới được đọc:
  - CEO/Org Admin: tenant-wide
  - PM: project-based (chỉ user thuộc dự án mình quản lý)
- Thiết kế dữ liệu hỗ trợ:
  - `employee_compensations` có `org_id`, `user_id` (join với `project_members` để hạn chế)

---

## 12. Migration & Seed Script Outline

### 12.1. Order of creation (khuyến nghị)

1. `organizations`, `org_quotas`
2. `users`, `org_memberships`, `org_invites`
3. `roles`, `permissions`, `role_permissions`, `user_roles`
4. Lookup: `task_statuses`, `task_priorities`, `task_types`
5. `projects`, `project_members`
6. `tasks`, `task_assignees`, `subtasks`, `tags`, `task_tags`
7. `work_period_locks`, `time_logs`
8. `reports`, `report_comments`, `report_reactions`
9. `documents`, `project_resources`
10. `job_levels`, `employee_compensations`
11. `impersonation_sessions`, `audit_logs`

---

## 13. Ví dụ query thiết kế (DB-agnostic SQL)

### 13.1. Lấy danh sách task “được giao cho tôi” trong Org, filter theo project + status + priority

```sql
SELECT
  t.id, t.title, t.status_code, t.priority_code, t.due_date, t.updated_at
FROM tasks t
JOIN task_assignees ta
  ON ta.org_id = t.org_id
 AND ta.task_id = t.id
WHERE t.org_id = :current_org_id
  AND ta.user_id = :current_user_id
  AND (:project_id IS NULL OR t.project_id = :project_id)
  AND (:status_code IS NULL OR t.status_code = :status_code)
  AND (:priority_code IS NULL OR t.priority_code = :priority_code)
  AND t.deleted_at IS NULL
ORDER BY t.due_date NULLS LAST, t.updated_at DESC;
```

### 13.2. Enforce scope theo Project (PM chỉ thấy project mình quản lý)

```sql
SELECT t.*
FROM tasks t
JOIN project_members pm
  ON pm.org_id = t.org_id
 AND pm.project_id = t.project_id
 AND pm.user_id = :current_user_id
WHERE t.org_id = :current_org_id
  AND pm.member_role = 'PM'
  AND t.deleted_at IS NULL;
```

### 13.3. Tính chi phí dự án theo thời gian làm Task (Task-based Costing)

-- Hệ thống tính tổng thời gian log của từng nhân sự cho mỗi Task rồi nhân với đơn giá.
-- Không tính riêng lẻ Subtask trong báo cáo chi phí để tránh phân mảnh dữ liệu.

```sql
SELECT
  tl.project_id,
  tl.task_id,
  tl.owner_user_id,
  SUM(tl.minutes) as total_task_minutes,
  SUM((tl.minutes / 60.0) * ec.hourly_cost_rate) AS task_cost_amount
FROM time_logs tl
JOIN employee_compensations ec
  ON ec.org_id = tl.org_id
 AND ec.user_id = tl.owner_user_id
 AND ec.effective_from <= tl.work_date
 AND (ec.effective_to IS NULL OR ec.effective_to >= tl.work_date)
WHERE tl.org_id = :current_org_id
  AND tl.project_id = :project_id
  AND tl.deleted_at IS NULL
GROUP BY tl.project_id, tl.task_id, tl.owner_user_id;
```

### 13.4. Check “locked period” để chặn update time log (logic minh hoạ)

-- Áp dụng cho cả task và subtask (vì subtask thuộc project thông qua task)

```sql
SELECT EXISTS (
  SELECT 1
  FROM work_period_locks wpl
  WHERE wpl.org_id = :current_org_id
    AND wpl.project_id = :project_id
    AND wpl.is_locked = TRUE
    AND :work_date BETWEEN wpl.period_start AND wpl.period_end
) AS is_locked;
```

---

## 14. Appendix

### 14.1. Glossary

- **Org / Organization / Tenant**: công ty khách hàng trong mô hình SaaS.
- **Project**: dự án thuộc Org.
- **RBAC**: phân quyền theo role.
- **ABAC**: phân quyền theo thuộc tính (ownership, thời gian, scope).
- **Soft delete**: không xoá vật lý; đánh dấu `deleted_at`.
- **Effective dating**: dữ liệu theo khoảng hiệu lực (lương theo thời gian).

### 14.2. Naming convention

- Table/column: `snake_case`, số ít hay số nhiều nhất quán (tài liệu dùng **số nhiều**: `projects`, `tasks`…).
- FK: `<ref>_id` (ví dụ `org_id`, `project_id`).
- Junction table: `<a>_<b>` hoặc tên nghiệp vụ (`task_assignees`, `role_permissions`).
- Timestamps: `*_at` (`created_at`, `updated_at`).

### 14.3. Data type guideline

- ID: `uuid` (khuyến nghị); nếu dùng `bigint` thì chuẩn hoá theo strategy ID.
- Tiền tệ: `numeric(18,2)` + `currency` (ISO-4217).
- Text dài: `text` (hoặc `varchar` có giới hạn khi cần).
- JSON: `jsonb` cho audit snapshots và metadata.
